---
phase: 03-new-project-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - commands/gsd/new-project.md
autonomous: true

must_haves:
  truths:
    - "When adversary is enabled in config, /gsd:new-project displays 'GSD > ADVERSARY REVIEW' banner and challenge summary after REQUIREMENTS.md creation, before user approval"
    - "When adversary is enabled in config, /gsd:new-project displays 'GSD > ADVERSARY REVIEW' banner and challenge summary after ROADMAP.md creation, before user approval"
    - "Debate loop terminates after at most 3 rounds regardless of user-configured max_rounds (CONV-01 hard cap)"
    - "When adversary is disabled in config (globally or per-checkpoint), the flow proceeds as before with no adversary review"
    - "REQUIREMENTS.md and ROADMAP.md contain no trace of the adversary review process (clean artifacts)"
  artifacts:
    - path: "commands/gsd/new-project.md"
      provides: "Adversary debate loop integration at requirements and roadmap checkpoints"
      contains: "ADVERSARY REVIEW"
  key_links:
    - from: "commands/gsd/new-project.md"
      to: "get-shit-done/references/planning-config.md"
      via: "execution_context @-reference"
      pattern: "planning-config\\.md"
    - from: "commands/gsd/new-project.md"
      to: "agents/gsd-adversary.md"
      via: "Task tool spawn with gsd-adversary agent"
      pattern: "gsd-adversary"
    - from: "commands/gsd/new-project.md Phase 7.5"
      to: "Phase 7 requirements commit"
      via: "Inserted after commit, before user approval presentation"
      pattern: "ADVERSARY REVIEW"
    - from: "commands/gsd/new-project.md Phase 8.5"
      to: "Phase 8 roadmapper return"
      via: "Inserted after roadmapper return, before user approval"
      pattern: "ADVERSARY REVIEW"
---

<objective>
Integrate adversary debate loop into /gsd:new-project at the requirements and roadmap checkpoints.

Purpose: This wires the adversary agent (Phase 1) and its configuration (Phase 2) into the new-project workflow, so requirements and roadmaps are stress-tested before user approval. This is the first concrete integration — the debate loop pattern established here will be reused by Phases 4 and 5.

Output: Modified `commands/gsd/new-project.md` with two adversary checkpoints and supporting infrastructure.
</objective>

<execution_context>
@/Users/zpyoung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zpyoung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-new-project-integration/03-RESEARCH.md
@.planning/phases/03-new-project-integration/03-CONTEXT.md
@.planning/phases/01-core-agent/01-01-SUMMARY.md

Key references inside the file being modified:
@commands/gsd/new-project.md
@agents/gsd-adversary.md
@get-shit-done/references/planning-config.md
@get-shit-done/references/ui-brand.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add adversary infrastructure and requirements checkpoint</name>
  <files>commands/gsd/new-project.md</files>
  <action>
Make three changes to `commands/gsd/new-project.md`:

**1. Add planning-config.md to execution_context section (line ~31-37):**

Add `@~/.claude/get-shit-done/references/planning-config.md` to the `<execution_context>` block. This provides the adversary config reading block as a reference.

**2. Add gsd-adversary to model lookup table in Phase 5.5 (line ~496-503):**

Add a new row to the model lookup table:

```
| gsd-adversary | sonnet | sonnet | haiku |
```

Rationale: Adversary reviews artifacts and generates challenges — sonnet is sufficient. Budget uses haiku.

**3. Insert Phase 7.5: Adversary Review — Requirements:**

Insert a new section between the REQUIREMENTS.md commit (end of Phase 7, after the `git commit` for requirements) and the user approval presentation ("Does this capture what you're building?").

The new Phase 7.5 section must contain:

a. **Config reading block** — Read adversary config for the "requirements" checkpoint using the `node -e` pattern from planning-config.md. Apply CONV-01 hard cap: `EFFECTIVE_MAX_ROUNDS = min(MAX_ROUNDS, 3)`.

b. **Skip logic** — If `CHECKPOINT_ENABLED = "false"`, skip entirely and continue to the existing approval step.

c. **Banner display** — Show `GSD > ADVERSARY REVIEW` stage banner followed by `Reviewing requirements...` spinner indicator.

d. **Debate loop** — Multi-round exchange:
   - Initialize: `ROUND=1`, `CONVERGED=false`
   - While ROUND <= EFFECTIVE_MAX_ROUNDS AND not CONVERGED:
     1. Read REQUIREMENTS.md content from disk (re-read each round to get latest after revisions)
     2. Read PROJECT.md summary (first ~50 lines) for project context
     3. Spawn gsd-adversary via Task tool with:
        - `subagent_type="gsd-adversary"`
        - Model from resolved model table (`{adversary_model}`)
        - Description: `"Adversary review: requirements (round {ROUND})"`
        - Prompt containing XML tags: `<artifact_type>requirements</artifact_type>`, `<artifact_content>`, `<round>`, `<max_rounds>`, and for round > 1: `<defense>` and `<previous_challenges>`, plus `<project_context>`
        - Round 1 prompt: Include `First, read ~/.claude/agents/gsd-adversary.md for your role and instructions.` followed by artifact_type, artifact_content, round, max_rounds, project_context
        - Round > 1 prompt: Same as round 1 plus defense and previous_challenges tags
     4. Parse adversary response: extract challenges (title, severity, concern) and convergence recommendation (CONTINUE/CONVERGE)
     5. If adversary recommends CONVERGE and ROUND > 1: set CONVERGED=true, break
     6. If ROUND < EFFECTIVE_MAX_ROUNDS: generate defense
        - For BLOCKING challenges: revise REQUIREMENTS.md on disk using Write/Edit tool
        - For MAJOR challenges: at Claude's discretion — may revise or note
        - For MINOR challenges: typically note without revision
        - Build DEFENSE text describing what changed and why, or why challenges were rejected
        - Store previous challenges for next round
     7. Increment ROUND

e. **Summary display** — After loop completes, show adversary review summary using ui-brand.md patterns:
   - `Adversary review complete` with challenge list
   - Each challenge shows severity marker and addressed/noted status
   - Use `checkmark` for addressed, `circle` for noted/minor, `warning` for unresolved at max rounds
   - Track which checkpoints ran for the Phase 10 completion banner

f. **Separate commit for revisions** — If the artifact was revised during the debate, commit the changes:
   ```bash
   git add .planning/REQUIREMENTS.md
   git commit -m "docs: incorporate adversary review feedback (requirements)"
   ```
   Only commit if actual revisions were made. Don't commit if all challenges were noted without revision.

**Important constraints:**
- Do NOT move or modify the existing user approval step — the adversary review goes BEFORE it
- Do NOT add per-challenge dismissal UI — the existing approval step handles user control
- The debate runs "silently" (no per-round display to user) — only the final summary is shown
- Artifacts must be clean — no adversary metadata in REQUIREMENTS.md
  </action>
  <verify>
Read commands/gsd/new-project.md and verify:
1. `planning-config.md` appears in execution_context
2. `gsd-adversary` row exists in model lookup table with correct model assignments
3. Phase 7.5 section exists between Phase 7 commit and user approval
4. Config reading block uses `node -e` pattern with `CHECKPOINT_NAME="requirements"`
5. CONV-01 hard cap applied: `min(MAX_ROUNDS, 3)` or equivalent
6. Task spawn includes all required XML tags (artifact_type, artifact_content, round, max_rounds, project_context)
7. Defense/previous_challenges included for round > 1
8. Summary display uses ui-brand.md patterns
9. Skip logic present for disabled checkpoint
10. Separate commit block for revisions (conditional)
  </verify>
  <done>
Phase 7.5 adversary review section is complete in new-project.md with config reading, debate loop, defense generation, summary display, and conditional revision commit. Model table and execution_context updated. The requirements checkpoint runs after requirements commit and before user approval, satisfying INTG-01 and CONV-01.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add roadmap checkpoint and update completion banner</name>
  <files>commands/gsd/new-project.md</files>
  <action>
Make two changes to `commands/gsd/new-project.md`:

**1. Insert Phase 8.5: Adversary Review — Roadmap:**

Insert a new section after the roadmapper return handling (after `## ROADMAP CREATED` is handled and roadmap is presented inline) but BEFORE the user approval step (`CRITICAL: Ask for approval before committing`).

The Phase 8.5 section follows the same debate loop pattern as Phase 7.5 but adapted for roadmap:

a. **Config reading block** — Same `node -e` pattern but with `CHECKPOINT_NAME="roadmap"`. Same CONV-01 hard cap.

b. **Skip logic** — If `CHECKPOINT_ENABLED = "false"`, skip to existing approval step.

c. **Banner display** — `GSD > ADVERSARY REVIEW` banner with `Reviewing roadmap...` spinner.

d. **Debate loop** — Same structure as requirements checkpoint:
   - Read ROADMAP.md from disk each round (re-read after revisions)
   - Spawn gsd-adversary with `<artifact_type>roadmap</artifact_type>` and ROADMAP.md content
   - Same defense/convergence logic as requirements
   - BLOCKING: revise ROADMAP.md on disk
   - MAJOR/MINOR: at Claude's discretion
   - Track convergence, build defense, loop

e. **Summary display** — Same format as requirements summary. Track checkpoint name.

f. **Conditional revision commit** — If roadmap was revised:
   ```bash
   git add .planning/ROADMAP.md
   git commit -m "docs: incorporate adversary review feedback (roadmap)"
   ```
   Only commit if revisions occurred. Note: ROADMAP.md is not committed yet at this point (the existing commit happens after user approval), so revisions here modify the on-disk file that will be committed in the existing flow. However, if revisions happen, we want to preserve the pre-revision state. The research recommends a separate commit AFTER the initial roadmap commit. Since the roadmap commit happens after approval in Phase 8, and our adversary runs before approval, the adversary revisions are incorporated into the artifact before the first commit. No separate commit needed — the revisions are folded into the existing commit.

   **Correction:** Since the roadmap commit happens AFTER user approval (at the end of Phase 8), and the adversary runs BEFORE approval, any revisions the adversary causes are already in the file when it gets committed. No separate commit is needed for roadmap revisions. The adversary just edits the on-disk ROADMAP.md and the normal commit captures the final state.

**2. Update Phase 10 completion banner:**

In the Phase 10 "Done" section, after the line:
```
**[N] phases** | **[X] requirements** | Ready to build checkmark
```

Add a conditional line:
```
Adversary reviewed: {list of checkpoints that ran, e.g., "requirements, roadmap"}
```

This line only appears if at least one adversary checkpoint ran during the session. Track which checkpoints ran using variables set during Phases 7.5 and 8.5 (e.g., `ADVERSARY_RAN_REQUIREMENTS=true`, `ADVERSARY_RAN_ROADMAP=true`).

**Important constraints:**
- The roadmap adversary review goes AFTER presenting the roadmap inline but BEFORE the approval AskUserQuestion
- Do NOT modify the existing approval options (Approve / Adjust phases / Review full file)
- Adversary runs once — if user selects "Adjust phases" after approval, no re-run
- The roadmapper already receives the latest requirements from disk (which may have been revised by the Phase 7.5 adversary), so the flow is naturally correct
- For the requirements checkpoint (Phase 7.5): requirements ARE already committed before adversary runs, so if revised, a SEPARATE commit captures the revision
- For the roadmap checkpoint (Phase 8.5): roadmap is NOT yet committed when adversary runs, so revisions are folded into the existing commit flow
  </action>
  <verify>
Read commands/gsd/new-project.md and verify:
1. Phase 8.5 section exists between roadmap presentation and user approval
2. Config reading block uses `CHECKPOINT_NAME="roadmap"`
3. CONV-01 hard cap applied
4. Task spawn uses `<artifact_type>roadmap</artifact_type>` with ROADMAP.md content
5. Defense/convergence logic matches Phase 7.5 pattern
6. Skip logic present for disabled checkpoint
7. Phase 10 completion banner includes conditional adversary mention
8. No duplicate adversary sections (exactly one for requirements, one for roadmap)
9. Existing user approval steps unchanged and positioned after adversary review
10. The requirements checkpoint does a separate revision commit (post-existing-commit revision)
11. The roadmap checkpoint does NOT need a separate commit (revisions folded into existing flow)
  </verify>
  <done>
Phase 8.5 adversary review section is complete in new-project.md. Roadmap checkpoint runs after roadmapper return and before user approval, satisfying INTG-02. Completion banner updated with adversary mention. Both checkpoints enforce CONV-01 hard cap of 3 rounds. The full adversary integration into /gsd:new-project is complete.
  </done>
</task>

</tasks>

<verification>
After both tasks, verify the complete integration:

1. **Structure check:** Read commands/gsd/new-project.md end-to-end and confirm:
   - execution_context includes planning-config.md reference
   - Model table has gsd-adversary row
   - Phase 7.5 exists between Phase 7 commit and user approval
   - Phase 8.5 exists between roadmap presentation and user approval
   - Phase 10 has conditional adversary mention
   - No other sections were accidentally modified or removed

2. **Pattern consistency:** Both debate loops follow the same pattern:
   - Config reading with node -e
   - CONV-01 hard cap (min(configured, 3))
   - Banner + spinner
   - Multi-round loop with adversary spawn
   - Defense generation with severity-appropriate handling
   - Summary display with addressed/noted markers
   - Skip logic when disabled

3. **Requirement coverage:**
   - INTG-01: Requirements adversary checkpoint present and correctly positioned
   - INTG-02: Roadmap adversary checkpoint present and correctly positioned
   - CONV-01: Both checkpoints enforce max 3 round hard cap

4. **Anti-pattern check:**
   - No separate defender agent spawned
   - Adversary does not modify artifacts directly
   - No re-run after user "Adjust"
   - No blocking on unresolved challenges
   - Each checkpoint reviews exactly one artifact
</verification>

<success_criteria>
- commands/gsd/new-project.md contains adversary review at both checkpoints (requirements and roadmap)
- Both checkpoints use the established config reading pattern from planning-config.md
- Both checkpoints enforce CONV-01 hard cap of 3 rounds
- Both checkpoints display summary before existing user approval step
- Adversary is skipped when disabled in config (globally or per-checkpoint)
- Model table includes gsd-adversary with correct profile assignments
- Completion banner reflects which adversary checkpoints ran
- Existing new-project flow is preserved — adversary is additive, not disruptive
</success_criteria>

<output>
After completion, create `.planning/phases/03-new-project-integration/03-01-SUMMARY.md`
</output>
