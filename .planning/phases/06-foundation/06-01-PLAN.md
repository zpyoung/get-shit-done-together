---
phase: 06-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/bin/adapters/codex.cjs
  - get-shit-done/bin/adapters/gemini.cjs
  - get-shit-done/bin/adapters/opencode.cjs
  - get-shit-done/templates/config.json
autonomous: true

must_haves:
  truths:
    - "Each adapter module exports detect() and invoke() functions conforming to the common contract"
    - "detect() returns { available, version, error } without ever throwing"
    - "invoke() returns { text, cli, duration, exitCode, error, errorType } without ever throwing"
    - "Error types are classified as NOT_FOUND, TIMEOUT, EXIT_ERROR, or PERMISSION"
    - "Config template includes co_planners section with enabled:false and timeout_ms:120000"
  artifacts:
    - path: "get-shit-done/bin/adapters/codex.cjs"
      provides: "Codex CLI adapter with detect and invoke"
      exports: ["detect", "invoke", "CLI_NAME"]
    - path: "get-shit-done/bin/adapters/gemini.cjs"
      provides: "Gemini CLI adapter with detect and invoke"
      exports: ["detect", "invoke", "CLI_NAME"]
    - path: "get-shit-done/bin/adapters/opencode.cjs"
      provides: "OpenCode adapter with detect and invoke"
      exports: ["detect", "invoke", "CLI_NAME"]
    - path: "get-shit-done/templates/config.json"
      provides: "Config template with co_planners section"
      contains: "co_planners"
  key_links:
    - from: "get-shit-done/bin/adapters/codex.cjs"
      to: "child_process.execSync"
      via: "require('child_process')"
      pattern: "execSync"
    - from: "get-shit-done/bin/adapters/gemini.cjs"
      to: "child_process.execSync"
      via: "require('child_process')"
      pattern: "sanitizeEnv"
    - from: "get-shit-done/bin/adapters/opencode.cjs"
      to: "child_process.execSync"
      via: "require('child_process')"
      pattern: "execSync"
---

<objective>
Create the three CLI adapter modules (codex, gemini, opencode) and update the config template with co-planner settings.

Purpose: Adapters are the atomic building blocks for Phase 6. Each encapsulates CLI-specific detection and invocation logic behind a common interface. The config template establishes the kill switch and timeout defaults. Plan 02 wires these into gsd-tools.cjs.

Output: Three adapter files in `get-shit-done/bin/adapters/` and updated `get-shit-done/templates/config.json`.
</objective>

<execution_context>
@/Users/zpyoung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zpyoung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-foundation/06-CONTEXT.md
@.planning/phases/06-foundation/06-RESEARCH.md
@get-shit-done/bin/gsd-tools.cjs (reference execGit pattern at line 225 and output/error helpers at line 469)
@get-shit-done/templates/config.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create adapter modules with shared classifyError helper</name>
  <files>
    get-shit-done/bin/adapters/codex.cjs
    get-shit-done/bin/adapters/gemini.cjs
    get-shit-done/bin/adapters/opencode.cjs
  </files>
  <action>
Create the `get-shit-done/bin/adapters/` directory and three adapter files. Each adapter follows the same contract:

**Shared pattern (implement in each file -- no shared module to avoid import complexity):**

```javascript
const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');
const os = require('os');

function classifyError(err) {
  if (err.signal === 'SIGTERM') return 'TIMEOUT';
  if (err.code === 'ENOENT' || err.status === 127) return 'NOT_FOUND';
  if (err.status === 126) return 'PERMISSION';
  return 'EXIT_ERROR';
}
```

**codex.cjs specifics:**
- `CLI_NAME = 'codex'`
- `detect()`: Run `codex --version` with 10s timeout, `stdio: 'pipe'`. Return `{ available: true, version: stdout.trim() }` on success. On error, classify and return `{ available: false, version: null, error: classifyError(err) }`.
- `invoke(prompt, options)`: Write prompt to temp file (`os.tmpdir()/gsd-codex-{timestamp}.txt`). Run `cat "{tmpFile}" | codex exec - --ephemeral --full-auto --skip-git-repo-check` with configurable timeout (default 120000ms), `stdio: 'pipe'`, `maxBuffer: 10MB`. Clean up temp file in finally block. Return `{ text, cli: 'codex', duration, exitCode, error, errorType }`. If model option provided, append ` -m "{model}"` to command.

**gemini.cjs specifics:**
- `CLI_NAME = 'gemini'`
- `detect()`: Same pattern as codex but `gemini --version`.
- `invoke(prompt, options)`: Write prompt to temp file. Run `cat "{tmpFile}" | gemini -p --output-format json` with sanitized environment (delete `DEBUG` from env copy to prevent Gemini CLI freeze). Parse JSON response -- extract `parsed.response` field. If JSON parse fails, use raw stdout. Include model flag ` -m "{model}"` if provided. Return common schema.
- Add `sanitizeEnv(env)` helper: copy env, delete `DEBUG`, return cleaned copy.

**opencode.cjs specifics:**
- `CLI_NAME = 'opencode'`
- `detect()`: Same pattern as codex but `opencode --version`. Important: only check exitCode for success, NOT stderr content (OpenCode emits Bun CPU warnings to stderr that are not errors).
- `invoke(prompt, options)`: Write prompt to temp file. Run `cat "{tmpFile}" | opencode run --format json` with configurable timeout. Parse JSON response defensively -- try to extract assistant text from JSON events. If JSON parse fails, use raw stdout. Include model flag ` -m "{model}"` if provided. Return common schema.
- Add `extractOpenCodeResponse(stdout)` helper: attempt `JSON.parse(stdout)`, extract text from response object. If parsing fails, return trimmed stdout as-is.

**IMPORTANT:** Each adapter must NEVER throw. All errors must be caught and returned as structured objects with `errorType` classification.
  </action>
  <verify>
Run `node -e "const a = require('./get-shit-done/bin/adapters/codex.cjs'); console.log(Object.keys(a))"` to verify exports. Repeat for gemini.cjs and opencode.cjs. Each must export `detect`, `invoke`, `CLI_NAME`. Also verify `node -c get-shit-done/bin/adapters/codex.cjs` (syntax check) passes for all three files.
  </verify>
  <done>
Three adapter files exist in `get-shit-done/bin/adapters/`. Each exports `detect()`, `invoke()`, and `CLI_NAME`. All files pass Node.js syntax check. Each adapter handles all four error types (NOT_FOUND, TIMEOUT, EXIT_ERROR, PERMISSION) without throwing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add co_planners section to config template</name>
  <files>get-shit-done/templates/config.json</files>
  <action>
Add a `co_planners` section to `get-shit-done/templates/config.json`:

```json
{
  "co_planners": {
    "enabled": false,
    "timeout_ms": 120000
  }
}
```

Place it after the `adversary` section (which is the closest conceptual neighbor -- both are optional external review agents). The default MUST be `enabled: false` (opt-in, not opt-out) per locked user decision.

Do NOT add per-checkpoint configuration, per-CLI agent lists, or any Phase 7+ config. Keep it minimal: just the kill switch and global timeout.
  </action>
  <verify>
Run `node -e "const c = require('./get-shit-done/templates/config.json'); console.log(c.co_planners)"` -- should print `{ enabled: false, timeout_ms: 120000 }`. Verify `co_planners.enabled === false` (not undefined, not null).
  </verify>
  <done>
Config template contains `co_planners.enabled: false` and `co_planners.timeout_ms: 120000`. No extra fields beyond these two.
  </done>
</task>

</tasks>

<verification>
1. All three adapter files exist: `ls get-shit-done/bin/adapters/`
2. Each adapter exports the correct interface: `detect`, `invoke`, `CLI_NAME`
3. No adapter throws on `require()` -- all load cleanly
4. Config template has `co_planners` section with correct defaults
5. Syntax check passes: `node -c` on all three adapter files
</verification>

<success_criteria>
- Three adapter files in `get-shit-done/bin/adapters/` each exporting `detect()`, `invoke()`, `CLI_NAME`
- All adapters conform to common return schema `{ text, cli, duration, exitCode, error, errorType }`
- Config template has `co_planners: { enabled: false, timeout_ms: 120000 }`
- Zero new npm dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/06-foundation/06-01-SUMMARY.md`
</output>
