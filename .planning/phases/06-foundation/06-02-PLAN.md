---
phase: 06-foundation
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - get-shit-done/bin/gsd-tools.cjs
  - bin/install.js
autonomous: true

must_haves:
  truths:
    - "User can run `gsd-tools.cjs coplanner detect` and see which CLIs are installed with version info"
    - "User can run `gsd-tools.cjs coplanner detect --json` and get structured JSON output"
    - "User can run `gsd-tools.cjs coplanner enabled` and see the kill switch status with its source"
    - "User can set co_planners.enabled:false in config.json and invoke returns silent skip"
    - "User can set GSD_CO_PLANNERS=true env var and it overrides config.json"
    - "User can invoke a CLI via `gsd-tools.cjs coplanner invoke codex --prompt text` and receive normalized output"
    - "When a CLI is missing/fails/times out, the command returns structured error instead of crashing"
    - "Adapters directory is copied during installation alongside other get-shit-done files"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.cjs"
      provides: "coplanner command group (detect, invoke, enabled)"
      contains: "coplanner"
    - path: "bin/install.js"
      provides: "Adapter directory installation support"
      contains: "adapters"
  key_links:
    - from: "get-shit-done/bin/gsd-tools.cjs"
      to: "get-shit-done/bin/adapters/*.cjs"
      via: "require() via loadAdapter()"
      pattern: "loadAdapter"
    - from: "get-shit-done/bin/gsd-tools.cjs"
      to: ".planning/config.json"
      via: "checkKillSwitch() reads co_planners.enabled"
      pattern: "co_planners"
    - from: "get-shit-done/bin/gsd-tools.cjs"
      to: "process.env.GSD_CO_PLANNERS"
      via: "env var override in checkKillSwitch()"
      pattern: "GSD_CO_PLANNERS"
    - from: "bin/install.js"
      to: "get-shit-done/bin/adapters/"
      via: "copyWithPathReplacement handles subdirectories recursively"
      pattern: "adapters"
---

<objective>
Wire adapter modules into gsd-tools.cjs as the `coplanner` command group and ensure the adapters/ directory is installed correctly.

Purpose: This plan connects the adapter building blocks (from Plan 01) to the GSD CLI interface, making detection, invocation, and kill switch functionality accessible to workflows and users. It also ensures the adapters/ directory survives the installation process.

Output: Three new gsd-tools.cjs commands (`coplanner detect`, `coplanner invoke`, `coplanner enabled`) and updated install.js.
</objective>

<execution_context>
@/Users/zpyoung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zpyoung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-foundation/06-CONTEXT.md
@.planning/phases/06-foundation/06-RESEARCH.md
@.planning/phases/06-foundation/06-01-SUMMARY.md
@get-shit-done/bin/gsd-tools.cjs
@bin/install.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add coplanner command group to gsd-tools.cjs</name>
  <files>get-shit-done/bin/gsd-tools.cjs</files>
  <action>
Add the `coplanner` command group to gsd-tools.cjs. This involves three parts:

**Part A: Helper functions** (add near the top, after existing helper functions like `execGit` around line 244):

1. `loadAdapter(cliName)` -- Load adapter from `adapters/` directory via `require()`. Returns the adapter module or null if file doesn't exist. Uses `path.join(__dirname, 'adapters', cliName + '.cjs')`.

2. `checkKillSwitch(cwd)` -- Check if co-planners are enabled. Returns `{ enabled: bool, source: "env"|"config"|"default" }`. Precedence: `process.env.GSD_CO_PLANNERS` (parse "true"/"1" as enabled) > `config.json co_planners.enabled` > default `false`.

3. `SUPPORTED_CLIS` constant -- `['codex', 'gemini', 'opencode']`.

**Part B: Command functions:**

1. `cmdCoplannerDetect(cwd, raw)` -- Iterate SUPPORTED_CLIS, load each adapter, call `adapter.detect()`. Collect results as `{ [cli]: { available, version, error } }`. If `raw` is true, output human-readable table:
```
CLI        Available  Version
codex      yes        codex-cli 0.101.0
gemini     no         NOT_FOUND
opencode   yes        1.1.65
```
If `raw` is false (default JSON mode), call `output(results, false)`.

2. `cmdCoplannerInvoke(cwd, cliName, prompt, options, raw)` -- First check kill switch via `checkKillSwitch(cwd)`. If disabled, return `{ skipped: true, reason: "co-planners disabled", source: killSwitch.source }` (NOT an error -- silent skip per user decision). Then load adapter for `cliName`. If adapter not found, return error result `{ text: "", cli: cliName, duration: 0, exitCode: 1, error: "Unknown CLI", errorType: "NO_ADAPTER" }`. Call `adapter.invoke(prompt, { timeout: options.timeout, model: options.model })`. Return result via `output()`.

3. `cmdCoplannerEnabled(cwd, raw)` -- Call `checkKillSwitch(cwd)` and return result via `output()`. If raw, print `enabled` or `disabled` plus source.

**Part C: Main switch case** (add before the `default:` case near end of file):

```javascript
case 'coplanner': {
  const subCmd = args[1];
  switch (subCmd) {
    case 'detect': {
      cmdCoplannerDetect(cwd, raw);
      break;
    }
    case 'invoke': {
      const cliName = args[2];
      if (!cliName) error('CLI name required: codex, gemini, or opencode');
      const promptIdx = args.indexOf('--prompt');
      const prompt = promptIdx !== -1 ? args[promptIdx + 1] : null;
      if (!prompt) error('--prompt required');
      const timeoutIdx = args.indexOf('--timeout');
      const timeout = timeoutIdx !== -1 ? parseInt(args[timeoutIdx + 1], 10) : undefined;
      const modelIdx = args.indexOf('--model');
      const model = modelIdx !== -1 ? args[modelIdx + 1] : undefined;
      cmdCoplannerInvoke(cwd, cliName, prompt, { timeout, model }, raw);
      break;
    }
    case 'enabled': {
      cmdCoplannerEnabled(cwd, raw);
      break;
    }
    default:
      error('Unknown coplanner subcommand: ' + subCmd + '. Use: detect, invoke, enabled');
  }
  break;
}
```

**IMPORTANT:** The `coplanner detect` command with `--raw` flag should output the human-readable table. Without `--raw`, it outputs JSON (standard gsd-tools.cjs convention). The `--json` flag mentioned in CONTEXT.md maps to the default JSON output mode (omit `--raw`). To achieve the behavior described in CONTEXT.md ("table by default, --json for structured"), the detect command should check for `--json` in args: if `--json` present, use `output(results, false)`; if no `--json`, output table. This is a departure from the standard gsd-tools.cjs convention where `--raw` means text output -- but it matches the locked user decision. Implement it as: default=table, `--json`=JSON output.

Also add the command group to the usage comment header at the top of the file.
  </action>
  <verify>
1. `node get-shit-done/bin/gsd-tools.cjs coplanner detect` -- Should output human-readable table
2. `node get-shit-done/bin/gsd-tools.cjs coplanner detect --json` -- Should output JSON
3. `node get-shit-done/bin/gsd-tools.cjs coplanner enabled` -- Should output `{ enabled: false, source: "default" }` or based on config
4. `GSD_CO_PLANNERS=true node get-shit-done/bin/gsd-tools.cjs coplanner enabled` -- Should show `{ enabled: true, source: "env" }`
5. `node get-shit-done/bin/gsd-tools.cjs coplanner invoke codex --prompt "say hello"` -- Should return result or skip if disabled
  </verify>
  <done>
gsd-tools.cjs has `coplanner` command group with `detect`, `invoke`, and `enabled` subcommands. Detection shows installed CLIs. Kill switch respects env var > config > default precedence. Invocation returns normalized output. All error paths return structured objects, never throw.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify install.js handles adapters/ directory</name>
  <files>bin/install.js</files>
  <action>
The `copyWithPathReplacement` function in install.js already handles recursive directory copying (line 692: `if (entry.isDirectory()) { copyWithPathReplacement(srcPath, destPath, ...) }`). Since the adapters/ directory lives inside `get-shit-done/bin/` and the installer copies the entire `get-shit-done/` tree via `copyWithPathReplacement(skillSrc, skillDest, ...)` (line 1393), the adapters/ directory should be copied automatically.

However, the adapters are `.cjs` files (not `.md`), so they will be handled by the `else` branch at line 718: `fs.copyFileSync(srcPath, destPath)` -- direct copy without path replacement. This is correct because adapter files use `__dirname` for path resolution, not hardcoded `~/.claude/` paths.

**Verification task:** Confirm this works by checking:
1. The `copyWithPathReplacement` function handles subdirectories recursively
2. `.cjs` files in subdirectories get copied via `copyFileSync` (the else branch)
3. The `get-shit-done` directory tree includes `bin/adapters/` after install

If the above is already working correctly (which it should be based on code analysis), no changes to install.js are needed. The recursive copy handles it.

**If verification reveals an issue** (e.g., the `get-shit-done/bin/` directory is not in the copy tree, or `.cjs` files are excluded), add explicit copy logic:

```javascript
// After the get-shit-done skill copy (line 1393)
// Verify adapters directory was included
const adaptersCheck = path.join(skillDest, 'bin', 'adapters');
if (!fs.existsSync(adaptersCheck)) {
  // Explicit copy as fallback
  const adaptersSrc = path.join(skillSrc, 'bin', 'adapters');
  if (fs.existsSync(adaptersSrc)) {
    copyWithPathReplacement(adaptersSrc, adaptersCheck, pathPrefix, runtime);
  }
}
```

The most likely outcome: no install.js changes needed -- the recursive copy already handles it.
  </action>
  <verify>
Run `node bin/install.js --claude --local` and verify:
1. `ls .claude/get-shit-done/bin/adapters/` shows all three adapter files
2. `node .claude/get-shit-done/bin/gsd-tools.cjs coplanner detect` works from installed location
  </verify>
  <done>
Adapters directory is correctly installed. Running `gsd-tools.cjs coplanner detect` from the installed location produces expected output. All three adapter .cjs files are present in the installed adapters/ directory.
  </done>
</task>

</tasks>

<verification>
1. `gsd-tools.cjs coplanner detect` outputs human-readable table of CLI availability
2. `gsd-tools.cjs coplanner detect --json` outputs structured JSON
3. `gsd-tools.cjs coplanner enabled` shows kill switch status and source
4. `GSD_CO_PLANNERS=true gsd-tools.cjs coplanner enabled` shows env override
5. `gsd-tools.cjs coplanner invoke codex --prompt "test"` returns normalized output (or skip if disabled)
6. Invoking with non-existent CLI returns structured error, not crash
7. `node bin/install.js --claude --local` copies adapters/ correctly
8. All three requirements (INFRA-01, INFRA-02, CORE-03) verified
</verification>

<success_criteria>
- `coplanner detect` works in both table and JSON modes
- `coplanner enabled` correctly reports kill switch status from env, config, or default
- `coplanner invoke` normalizes CLI output to common schema
- Missing/failed CLIs produce structured error responses, never crashes
- Adapters directory survives the installation process
- All Phase 6 success criteria from ROADMAP.md are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/06-foundation/06-02-SUMMARY.md`
</output>
