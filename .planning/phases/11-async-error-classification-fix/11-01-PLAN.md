---
phase: 11-async-error-classification-fix
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - get-shit-done/bin/adapters/codex.cjs
  - get-shit-done/bin/adapters/gemini.cjs
  - get-shit-done/bin/adapters/opencode.cjs
  - get-shit-done/bin/gsd-tools.test.cjs
autonomous: true

must_haves:
  truths:
    - "classifyError returns NOT_FOUND for exit code 127 from async path (err.code = 127)"
    - "classifyError returns NOT_FOUND for exit code 127 from sync path (err.status = 127)"
    - "classifyError returns PERMISSION for exit code 126 from async path (err.code = 126)"
    - "classifyError returns PERMISSION for exit code 126 from sync path (err.status = 126)"
    - "classifyError returns TIMEOUT for SIGTERM signal async shape (err.code = null)"
    - "classifyError returns TIMEOUT for SIGTERM signal sync shape (err.status = null)"
    - "classifyError returns NOT_FOUND for ENOENT string code (spawn failure)"
    - "classifyError returns EXIT_ERROR for other exit codes (both error shapes)"
  artifacts:
    - path: "get-shit-done/bin/adapters/codex.cjs"
      provides: "Fixed classifyError + exported for testing"
      contains: "typeof err.code === 'number'"
      exports: ["detect", "invoke", "invokeAsync", "CLI_NAME", "classifyError"]
    - path: "get-shit-done/bin/adapters/gemini.cjs"
      provides: "Fixed classifyError + exported for testing"
      contains: "typeof err.code === 'number'"
      exports: ["detect", "invoke", "invokeAsync", "CLI_NAME", "classifyError"]
    - path: "get-shit-done/bin/adapters/opencode.cjs"
      provides: "Fixed classifyError + exported for testing"
      contains: "typeof err.code === 'number'"
      exports: ["detect", "invoke", "invokeAsync", "CLI_NAME", "classifyError"]
    - path: "get-shit-done/bin/gsd-tools.test.cjs"
      provides: "classifyError unit tests for all 3 adapters"
      contains: "classifyError"
  key_links:
    - from: "get-shit-done/bin/adapters/codex.cjs"
      to: "classifyError"
      via: "exitCode extraction from both err.status and numeric err.code"
      pattern: "err\\.status \\|\\| \\(typeof err\\.code === 'number'"
    - from: "get-shit-done/bin/gsd-tools.test.cjs"
      to: "get-shit-done/bin/adapters/codex.cjs"
      via: "require('./adapters/codex.cjs').classifyError"
      pattern: "require.*adapters.*classifyError"
---

<objective>
Fix classifyError in all three CLI adapters to correctly classify exit codes 127 (NOT_FOUND) and 126 (PERMISSION) from the async invocation path, and add comprehensive unit tests.

Purpose: The async path (`invokeAsync` via `exec`) stores exit codes in `err.code` (number), but `classifyError` only checks `err.status` for numeric exit codes. This causes async errors to fall through to `EXIT_ERROR` instead of the correct classification. The sync path (`invoke` via `execSync`) works correctly because it uses `err.status`.

Output: Fixed classifyError in 3 adapters + unit tests proving both sync and async error shapes are handled correctly.
</objective>

<execution_context>
@/Users/zpyoung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zpyoung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-async-error-classification-fix/11-RESEARCH.md

Source files:
@get-shit-done/bin/adapters/codex.cjs
@get-shit-done/bin/adapters/gemini.cjs
@get-shit-done/bin/adapters/opencode.cjs
@get-shit-done/bin/gsd-tools.test.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED — Export classifyError from all 3 adapters and add failing unit tests</name>
  <files>
    get-shit-done/bin/adapters/codex.cjs
    get-shit-done/bin/adapters/gemini.cjs
    get-shit-done/bin/adapters/opencode.cjs
    get-shit-done/bin/gsd-tools.test.cjs
  </files>
  <action>
**Step 1: Export classifyError from all 3 adapters FIRST (prerequisite for testability).**

In each of the 3 adapter files, update `module.exports` to include `classifyError`:

**Replace** (in codex.cjs, gemini.cjs, opencode.cjs):
```javascript
module.exports = { detect, invoke, invokeAsync, CLI_NAME };
```

**With:**
```javascript
module.exports = { detect, invoke, invokeAsync, CLI_NAME, classifyError };
```

Do NOT modify the classifyError function body yet — it stays buggy for the RED phase. The export is a non-behavioral change that enables testability.

**Step 2: Add classifyError test suite to gsd-tools.test.cjs.**

Add a new `describe` block at the end of `gsd-tools.test.cjs` for classifyError tests. Import all 3 adapters via require:

```javascript
const codexAdapter = require('./adapters/codex.cjs');
const geminiAdapter = require('./adapters/gemini.cjs');
const opencodeAdapter = require('./adapters/opencode.cjs');
```

Create a shared test suite pattern — for EACH adapter, test these 9 cases (each case = 1 `it()` block):

1. **exit 127 sync shape** — `{ status: 127, signal: null }` → `'NOT_FOUND'`
2. **exit 127 async shape** — `{ code: 127, signal: null }` → `'NOT_FOUND'` (THIS WILL FAIL — RED)
3. **exit 126 sync shape** — `{ status: 126, signal: null }` → `'PERMISSION'`
4. **exit 126 async shape** — `{ code: 126, signal: null }` → `'PERMISSION'` (THIS WILL FAIL — RED)
5. **SIGTERM async shape** — `{ signal: 'SIGTERM', code: null }` → `'TIMEOUT'`
6. **SIGTERM sync shape** — `{ signal: 'SIGTERM', status: null }` → `'TIMEOUT'`
7. **ENOENT string** — `{ code: 'ENOENT', signal: null }` → `'NOT_FOUND'`
8. **other exit code sync shape** — `{ status: 1, signal: null }` → `'EXIT_ERROR'`
9. **other exit code async shape** — `{ code: 42, signal: null }` → `'EXIT_ERROR'`

Use `describe('classifyError', () => { ... })` as outer block, with nested `describe` per adapter: `describe('codex adapter', () => { ... })`.

Use `assert.strictEqual` for all assertions (matching existing test patterns). Each assertion gets its own `it()` block — no multi-assertion tests.

NOTE: Tests for cases 2 and 4 MUST fail with assertion errors (not TypeError) before the fix — this confirms the bug exists via clean RED failures. The export in Step 1 ensures `classifyError` is a real function, not `undefined`.
  </action>
  <verify>
Run `node --test get-shit-done/bin/gsd-tools.test.cjs 2>&1 | grep -E '(pass|fail|classifyError)'` — expect test cases 2 and 4 (async shape 127 and 126) to FAIL with assertion errors for all 3 adapters (6 failures total). All other tests (including cases 1, 3, 5-9) must PASS. Verify no TypeError crashes.
  </verify>
  <done>
classifyError exported from all 3 adapters (non-behavioral change). 9 test cases per adapter exist (27 total). Cases 2 and 4 fail with assertion errors (not TypeError) confirming the bug. All other tests pass cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: GREEN — Fix classifyError function body in all 3 adapters</name>
  <files>
    get-shit-done/bin/adapters/codex.cjs
    get-shit-done/bin/adapters/gemini.cjs
    get-shit-done/bin/adapters/opencode.cjs
  </files>
  <action>
In each of the 3 adapter files, apply the identical fix to the `classifyError` function body. The `module.exports` already includes `classifyError` (done in Task 1).

**Replace** the current classifyError function:
```javascript
function classifyError(err) {
  if (err.signal === 'SIGTERM') return 'TIMEOUT';
  if (err.code === 'ENOENT' || err.status === 127) return 'NOT_FOUND';
  if (err.status === 126) return 'PERMISSION';
  return 'EXIT_ERROR';
}
```

**With** the fixed version:
```javascript
function classifyError(err) {
  if (err.signal === 'SIGTERM') return 'TIMEOUT';
  // err.status = exit code from execSync; err.code = exit code (number) from exec
  const exitCode = err.status || (typeof err.code === 'number' ? err.code : undefined);
  if (err.code === 'ENOENT' || exitCode === 127) return 'NOT_FOUND';
  if (exitCode === 126) return 'PERMISSION';
  return 'EXIT_ERROR';
}
```

**CRITICAL — Do NOT change anything else:**
- Do NOT modify the `exitCode: err.code || 1` line in `invokeAsync` — it is correct for async path
- Do NOT modify the `exitCode: err.status || 1` line in `invoke` — it is correct for sync path
- Do NOT modify `module.exports` — it already exports classifyError from Task 1
- Do NOT add any new imports, dependencies, or shared modules

**Why this fix works:**
- `err.status` is checked first (truthy for sync errors where it's a number like 127)
- For async errors, `err.status` is `undefined` (falsy), so `typeof err.code === 'number'` is evaluated
- For async errors, `err.code` is a number (127, 126, etc.), so it becomes the exitCode
- For ENOENT spawn failures, `err.code` is the string `'ENOENT'`, which `typeof` excludes (not a number)
- For SIGTERM, `err.code` is `null`, which `typeof null === 'object'` excludes (not a number)
- The `err.code === 'ENOENT'` string check is preserved as a separate fallback

**Note on `err.status = 0` edge case:** The `||` operator skips `err.status = 0`, falling through to `err.code`. This is acceptable because `err.status = 0` means the process exited successfully — an error object with exit code 0 is not a real classification target. In Node.js, `execSync` only throws when `status !== 0`, and `exec` only passes `err` when the process fails. A test for `{ status: 0, code: 127 }` would be testing a synthetic error shape that never occurs in practice.
  </action>
  <verify>
Run `node --test get-shit-done/bin/gsd-tools.test.cjs` — ALL tests must pass, including the previously-failing async shape tests. Zero failures.
  </verify>
  <done>
All 3 adapters have the fixed classifyError (handles both err.status and numeric err.code). All 27 tests pass — async error shapes correctly classified as NOT_FOUND (127) and PERMISSION (126). Both SIGTERM shapes (async and sync) return TIMEOUT.
  </done>
</task>

</tasks>

<verification>
1. `node --test get-shit-done/bin/gsd-tools.test.cjs` — all tests pass (0 failures)
2. `grep -c 'typeof err.code' get-shit-done/bin/adapters/*.cjs` — all 3 files show count of 1
3. `grep 'classifyError' get-shit-done/bin/adapters/*.cjs | grep 'module.exports'` — all 3 files export classifyError
4. `node -e "const a = require('./get-shit-done/bin/adapters/codex.cjs'); console.log(typeof a.classifyError)"` — prints "function"
</verification>

<success_criteria>
- All classifyError unit tests pass for all 3 adapters (27 test cases: 9 per adapter)
- Async error shape { code: 127 } classified as NOT_FOUND (not EXIT_ERROR)
- Async error shape { code: 126 } classified as PERMISSION (not EXIT_ERROR)
- Sync error shapes still work (no regression)
- SIGTERM, ENOENT, and other exit codes still correctly classified
- classifyError exported from all 3 adapter modules
- No changes to invokeAsync exitCode line or invoke exitCode line
- All pre-existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-async-error-classification-fix/11-01-SUMMARY.md`
</output>
