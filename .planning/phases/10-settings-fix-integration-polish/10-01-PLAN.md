---
phase: 10-settings-fix-integration-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - commands/gsd/settings.md
  - get-shit-done/bin/gsd-tools.cjs
autonomous: true

must_haves:
  truths:
    - "User running settings flow sees inline badges (installed/not installed/status unknown) on co-planner agent options when co-planners are toggled to Yes"
    - "gsd-tools.cjs docstring lists all 5 coplanner subcommands: detect, invoke, invoke-all, enabled, agents"
    - "Creating a new config.json via cmdConfigEnsureSection includes co_planners section with enabled: false and timeout_ms: 120000"
  artifacts:
    - path: "commands/gsd/settings.md"
      provides: "Settings command with Bash in allowed-tools and detection badge instructions"
      contains: "Bash"
    - path: "get-shit-done/bin/gsd-tools.cjs"
      provides: "Expanded docstring and co_planners config defaults"
      contains: "coplanner invoke-all"
  key_links:
    - from: "commands/gsd/settings.md"
      to: "get-shit-done/bin/gsd-tools.cjs"
      via: "coplanner detect --raw command execution"
      pattern: "coplanner detect"
    - from: "get-shit-done/bin/gsd-tools.cjs cmdConfigEnsureSection"
      to: ".planning/config.json"
      via: "JSON.stringify defaults including co_planners"
      pattern: "co_planners.*enabled.*false"
---

<objective>
Wire CLI detection into the settings flow, expand the stale coplanner docstring, and fix config initialization to include the co_planners section.

Purpose: Close three gaps from the v2.2 milestone audit — settings cannot run detection (missing Bash tool), docstring is stale (missing agents + invoke-all subcommands), and config init omits co_planners defaults.
Output: Updated settings.md with detection badges and Bash tool, updated gsd-tools.cjs with expanded docstring and co_planners in cmdConfigEnsureSection.
</objective>

<execution_context>
@/Users/zpyoung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zpyoung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@commands/gsd/settings.md
@get-shit-done/bin/gsd-tools.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Bash tool and detection badges to settings command</name>
  <files>commands/gsd/settings.md</files>
  <action>
  Two changes in `commands/gsd/settings.md`:

  **Change 1 — Frontmatter (lines 1-8):**
  Add `Bash` to the `allowed-tools` list between `Write` and `AskUserQuestion`:
  ```yaml
  allowed-tools:
    - Read
    - Write
    - Bash
    - AskUserQuestion
  ```

  **Change 2 — Co-planner agent options with detection badges (lines 131-156):**
  Update the comment block and agent selection section to include detection badge instructions.

  Between the co-planner toggle question (line 134) and the agent selection question (line 148), add detection instructions:

  Replace the existing comment at lines 143-146:
  ```
  // ONLY show if co-planners = "Yes":
  // First detect which CLIs are installed:
  // Run: node ~/.claude/get-shit-done/bin/gsd-tools.cjs coplanner detect --raw
  // Use results to annotate options with (installed) or (not installed)
  ```

  With expanded detection instructions:
  ```
  // ONLY show if co-planners = "Yes":
  // 1. Show: "Detecting installed CLIs..."
  // 2. Run: node ~/.claude/get-shit-done/bin/gsd-tools.cjs coplanner detect
  //    (uses Bash tool — outputs JSON)
  // 3. Parse JSON result and map each CLI to badge text:
  //    - available: true                    → "(installed)"
  //    - available: false, error: NOT_FOUND → "(not installed)"
  //    - available: false, other error      → "(status unknown)"
  //    - detection failure/timeout          → "(status unknown)"
  // 4. Annotate options below with badge text inline:
  ```

  Update the agent selection options (lines 151-155) to include badge annotation instructions:
  ```
  options: [
    { label: "codex (<badge>)", description: "OpenAI Codex CLI" },
    { label: "gemini (<badge>)", description: "Google Gemini CLI" },
    { label: "opencode (<badge>)", description: "OpenCode CLI" }
  ]
  ```
  Where `<badge>` is replaced with the actual detection result badge at runtime.

  After the agent selection question block (after line 156), add a note instruction:
  ```
  // If any selected agent has "(not installed)" or "(status unknown)" badge:
  // Display note: "Note: Agents marked as not-installed will be skipped until installed."
  ```

  Also update ALL per-checkpoint override agent option blocks (lines 172-176, 183-186, 194-197, 203-206) to use the same badge annotation pattern from the detection results. The detection runs only once — reuse the cached results for all checkpoint agent lists.
  </action>
  <verify>
  1. Read commands/gsd/settings.md and confirm:
     - Line 7 in frontmatter includes `- Bash`
     - The co-planner section includes detection instructions with badge mapping
     - Agent options reference `<badge>` annotation pattern
     - Per-checkpoint options also reference badge annotations
     - Warning note about not-installed agents is present
  2. Verify no other frontmatter entries were modified
  </verify>
  <done>
  settings.md frontmatter includes Bash in allowed-tools. Detection badge instructions document the full flow: run detect, parse JSON, map to exact badge text "(installed)" / "(not installed)" / "(status unknown)", annotate agent options, show warning note for not-installed selections. All 5 agent selection blocks (global + 4 checkpoint) reference detection badges.
  </done>
</task>

<task type="auto">
  <name>Task 2: Expand docstring and fix config init in gsd-tools.cjs</name>
  <files>get-shit-done/bin/gsd-tools.cjs</files>
  <action>
  Two changes in `get-shit-done/bin/gsd-tools.cjs`:

  **Change 1 — Expand coplanner docstring (lines 121-125):**
  Replace the current Co-Planner Operations section:
  ```javascript
   * Co-Planner Operations:
   *   coplanner detect [--raw]           Detect installed CLIs (JSON default, table with --raw)
   *   coplanner invoke <cli> --prompt    Invoke a CLI adapter with prompt
   *     [--timeout N] [--model name]
   *   coplanner enabled                  Check kill switch status and source
  ```

  With the expanded version listing all 5 subcommands:
  ```javascript
   * Co-Planner Operations:
   *   coplanner detect [--raw]           Detect installed CLIs (JSON default, table with --raw)
   *   coplanner invoke <cli> --prompt    Invoke a CLI adapter with prompt
   *     [--timeout N] [--model name]     Reads co_planners.timeout_ms from config
   *   coplanner invoke-all               Invoke all resolved agents in parallel
   *     --prompt-file <path>             Reads prompt from file (avoids shell quoting)
   *     [--checkpoint name]              Resolve agents from co_planners.checkpoints config
   *     [--agents a,b] [--timeout N]     Override agent list; supports --raw
   *     [--model name]
   *   coplanner enabled [--raw]          Check kill switch status and source
   *   coplanner agents [checkpoint]      List agents for checkpoint (from co_planners.agents/checkpoints)
   *     [--raw]                          Supports --raw for comma-separated output
  ```

  Cross-reference: The dispatch block at lines 5557-5610 confirms all 5 subcommands exist. The error message on line 5607 already lists them: `detect, invoke, invoke-all, enabled, agents`.

  Note: `enabled` also supports `--raw` (add `[--raw]` to its line). Verify by checking the `cmdCoplannerEnabled` function signature.

  **Change 2 — Add co_planners to cmdConfigEnsureSection defaults (lines 722-741):**
  In the `hardcoded` object (lines 722-736), add `co_planners` section after the `workflow` block:
  ```javascript
  const hardcoded = {
    model_profile: 'balanced',
    commit_docs: true,
    search_gitignored: false,
    branching_strategy: 'none',
    phase_branch_template: 'gsd/phase-{phase}-{slug}',
    milestone_branch_template: 'gsd/{milestone}-{slug}',
    workflow: {
      research: true,
      plan_check: true,
      verifier: true,
    },
    co_planners: {
      enabled: false,
      timeout_ms: 120000,
    },
    parallelization: true,
    brave_search: hasBraveSearch,
  };
  ```

  Minimal defaults per locked decision: only `enabled: false` and `timeout_ms: 120000`. Do NOT add `agents` or `checkpoints` keys.

  In the `defaults` merge (lines 737-741), add `co_planners` to the deep merge list following the same pattern as `workflow`:
  ```javascript
  const defaults = {
    ...hardcoded,
    ...userDefaults,
    workflow: { ...hardcoded.workflow, ...(userDefaults.workflow || {}) },
    co_planners: { ...hardcoded.co_planners, ...(userDefaults.co_planners || {}) },
  };
  ```

  This ensures user-level defaults for co_planners keys merge correctly instead of completely overwriting the hardcoded defaults.
  </action>
  <verify>
  1. Run `node get-shit-done/bin/gsd-tools.cjs --help 2>&1 | head -5` to confirm the script still parses without syntax errors
  2. Read gsd-tools.cjs lines 121-135 and confirm all 5 coplanner subcommands are listed in the docstring
  3. Read gsd-tools.cjs around the cmdConfigEnsureSection function and confirm:
     - `co_planners: { enabled: false, timeout_ms: 120000 }` is in the `hardcoded` object
     - `co_planners` appears in the `defaults` deep merge alongside `workflow`
  4. Cross-reference docstring against dispatch block (line 5607 error message) to confirm all listed subcommands match
  </verify>
  <done>
  gsd-tools.cjs docstring lists all 5 coplanner subcommands (detect, invoke, invoke-all, enabled, agents) with flags and config key hints. cmdConfigEnsureSection hardcoded defaults include co_planners section with enabled: false and timeout_ms: 120000, and the merge pattern deep-merges co_planners like workflow.
  </done>
</task>

</tasks>

<verification>
1. **Settings detection flow**: Read `commands/gsd/settings.md` frontmatter — must include `Bash`. Co-planner section must include detection badge instructions with exact badge text.
2. **Docstring completeness**: Read `get-shit-done/bin/gsd-tools.cjs` docstring — must list detect, invoke, invoke-all, enabled, agents subcommands.
3. **Config init**: Read `cmdConfigEnsureSection` — `hardcoded` must contain `co_planners: { enabled: false, timeout_ms: 120000 }`. `defaults` merge must include `co_planners` deep merge line.
4. **No regressions**: `node get-shit-done/bin/gsd-tools.cjs coplanner detect` still executes without error.
</verification>

<success_criteria>
- settings.md allowed-tools includes Bash
- Settings co-planner agent options include detection badge instructions with "(installed)" / "(not installed)" / "(status unknown)" mapping
- All 5 per-checkpoint agent selection blocks reference detection badges
- Warning note about not-installed agents documented in settings flow
- gsd-tools.cjs docstring expanded to list all 5 coplanner subcommands with flags
- cmdConfigEnsureSection hardcoded object includes co_planners with minimal defaults
- cmdConfigEnsureSection defaults merge includes co_planners deep merge
- gsd-tools.cjs executes without syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-settings-fix-integration-polish/10-01-SUMMARY.md`
</output>
