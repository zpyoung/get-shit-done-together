---
phase: 09-multi-agent-orchestration
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - commands/gsd/new-project.md
  - commands/gsd/plan-phase.md
  - commands/gsd/execute-phase.md
autonomous: true

must_haves:
  truths:
    - "All four co-planner review sections use invoke-all instead of sequential per-agent loops"
    - "Per-agent feedback blocks display before the merged synthesis section"
    - "Merged synthesis is organized by theme with bracket-tag attribution [Agent1, Agent2]"
    - "Partial failure shows inline warning at top of synthesis noting which agent failed and why"
    - "Total failure skips review entirely with warning, same as Phase 8 behavior"
  artifacts:
    - path: "commands/gsd/new-project.md"
      provides: "invoke-all at requirements (Phase 7.3) and roadmap (Phase 8.3) checkpoints"
      contains: "coplanner invoke-all"
    - path: "commands/gsd/plan-phase.md"
      provides: "invoke-all at plan checkpoint (step 12.3)"
      contains: "coplanner invoke-all"
    - path: "commands/gsd/execute-phase.md"
      provides: "invoke-all at verification checkpoint (step 7.3)"
      contains: "coplanner invoke-all"
  key_links:
    - from: "commands/gsd/new-project.md"
      to: "get-shit-done/bin/gsd-tools.cjs"
      via: "coplanner invoke-all --checkpoint requirements --prompt-file"
      pattern: "coplanner invoke-all"
    - from: "commands/gsd/plan-phase.md"
      to: "get-shit-done/bin/gsd-tools.cjs"
      via: "coplanner invoke-all --checkpoint plan --prompt-file"
      pattern: "coplanner invoke-all"
    - from: "commands/gsd/execute-phase.md"
      to: "get-shit-done/bin/gsd-tools.cjs"
      via: "coplanner invoke-all --checkpoint verification --prompt-file"
      pattern: "coplanner invoke-all"
---

<objective>
Replace sequential "for each agent" co-planner loops in all workflow commands with single `invoke-all` calls and add theme-based merged synthesis with bracket-tag attribution.

Purpose: Workflow commands now invoke all configured agents in parallel at each checkpoint, display per-agent feedback blocks, then produce a single merged synthesis organized by theme (not by agent) with inline source attribution.
Output: Three updated command files with parallel invocation and theme-based synthesis at all four co-planner checkpoints.
</objective>

<execution_context>
@/Users/zpyoung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zpyoung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-multi-agent-orchestration/09-01-SUMMARY.md
@commands/gsd/new-project.md
@commands/gsd/plan-phase.md
@commands/gsd/execute-phase.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace sequential loops with invoke-all in new-project.md (requirements + roadmap)</name>
  <files>commands/gsd/new-project.md</files>
  <action>
Update both co-planner review sections in new-project.md (Phase 7.3 and Phase 8.3) to use the new `coplanner invoke-all` command instead of the sequential "for each agent" loop.

**For Phase 7.3 (Co-Planner Review -- Requirements):**

Replace the current "For each agent in agents array" sequential loop with:

1. **Agent resolution stays the same** -- keep the existing `coplanner agents "requirements"` call and empty-array skip logic.
2. **Replace the per-agent loop** with a single invoke-all call:
   - Write the review prompt to a temp file (same prompt content as current, with `{PROJECT_CONTEXT}` and `{ARTIFACT_CONTENT}` substituted).
   - Invoke all agents in parallel:
     ```bash
     RESULTS_JSON=$(node ~/.claude/get-shit-done/bin/gsd-tools.cjs coplanner invoke-all --checkpoint "requirements" --prompt-file "$PROMPT_FILE")
     rm -f "$PROMPT_FILE"
     ```
   - Parse `RESULTS_JSON`. Extract `results` array: `[{agent, status, response, error, errorType, duration}]`.
3. **Failure triage** (replaces individual error checks):
   - Count successes and failures from results array.
   - If ALL failed: display `⚠ All co-planners failed. Proceeding with adversary review only.` and skip to Phase 7.5.
   - If SOME failed: display inline warning: `⚠ {N} of {M} agents failed ({agent}: {errorType})` at the top of the output.
4. **Per-agent feedback blocks** remain the same format as Phase 8 (display name mapping, Suggestions/Challenges/Endorsements parsing). Loop over successful results.
5. **Replace the existing synthesis section** with a new **Merged Synthesis** section:
   - Organize feedback by theme (e.g., "Missing Requirements", "Scope Concerns", "Feasibility Issues") rather than by agent.
   - Use bracket-tag attribution inline: `[Codex]`, `[Gemini CLI]`, `[Codex, OpenCode]` after each point.
   - For conflicts between agents, highlight explicitly: `Codex suggested X but OpenCode flagged Y -- {resolution with one-line rationale}`.
   - Keep the accept/reject/note table but add a "Source(s)" column showing which agent(s) raised each item.
   - Keep the same acceptance criteria (accept gaps/contradictions/feasibility, reject stylistic/speculative).

**For Phase 8.3 (Co-Planner Review -- Roadmap):**

Apply the exact same structural changes as Phase 7.3, but with checkpoint `"roadmap"` and the roadmap-specific prompt content and artifact references. The synthesis section should use the same theme-based format with bracket-tag attribution.

**Key structural changes (both sections):**
- Remove the "For each agent in agents array:" loop header and per-agent invoke calls
- Replace with single `invoke-all` call that returns all results at once
- Add failure triage section between invocation and feedback display
- Add "Merged Synthesis" heading with theme organization after per-agent blocks
- Update the synthesis table to include "Source(s)" column with bracket attribution
- Conditional commit logic stays the same (commit if artifact was revised)
  </action>
  <verify>
1. `grep -c "coplanner invoke-all" commands/gsd/new-project.md` returns 2 (one per checkpoint)
2. `grep -c "For each agent" commands/gsd/new-project.md` returns 0 (sequential loops removed)
3. `grep -c "coplanner invoke " commands/gsd/new-project.md` returns 0 (old single-agent invoke calls removed from co-planner sections -- note: adversary sections may still exist)
4. `grep "Merged Synthesis" commands/gsd/new-project.md` returns matches (theme-based sections added)
5. `grep "prompt-file" commands/gsd/new-project.md` returns matches (temp file approach used)
6. Verify both Phase 7.3 and Phase 8.3 sections contain the failure triage pattern
  </verify>
  <done>Both co-planner review sections in new-project.md (requirements and roadmap) use `coplanner invoke-all` for parallel invocation, display per-agent feedback blocks followed by a theme-based merged synthesis with bracket-tag attribution, and handle partial/total failures gracefully.</done>
</task>

<task type="auto">
  <name>Task 2: Replace sequential loops with invoke-all in plan-phase.md and execute-phase.md</name>
  <files>
    commands/gsd/plan-phase.md
    commands/gsd/execute-phase.md
  </files>
  <action>
Update both remaining co-planner review sections to use `coplanner invoke-all` with theme-based synthesis.

**For plan-phase.md step 12.3 (Co-Planner Review -- Plans):**

1. **Agent resolution stays the same** -- keep existing `coplanner agents "plan"` call and empty-array skip.
2. **Replace the per-agent loop** with single invoke-all:
   - Write the plan review prompt to a temp file (same content as current, with `{REQUIREMENTS_CONTEXT}`, `{ROADMAP_CONTEXT}`, and `{ARTIFACT_CONTENT}` substituted).
   - Invoke: `RESULTS_JSON=$(node ~/.claude/get-shit-done/bin/gsd-tools.cjs coplanner invoke-all --checkpoint "plan" --prompt-file "$PROMPT_FILE")`
   - Parse results array.
3. **Failure triage**: Same pattern as new-project.md -- all-failed skips to step 12.5, some-failed shows warning.
4. **Per-agent feedback blocks**: Same format (display name mapping, three sections).
5. **Merged Synthesis**: Theme-based organization with bracket-tag attribution. Use plan-specific acceptance criteria (accept logical gaps/dependency conflicts/task ordering issues/wiring gaps; reject stylistic/scope expansion).
6. **Update synthesis table** to include "Source(s)" column.
7. Keep conditional commit with scope `docs(${PHASE}): incorporate co-planner feedback (plans)`.

**For execute-phase.md step 7.3 (Co-Planner Review -- Verification):**

1. **Agent resolution and skip conditions stay the same** -- keep existing `coplanner agents "verification"` call, skip on empty agents, `gaps_found`, or `re_verification`.
2. **Replace the per-agent loop** with single invoke-all:
   - Write the verification review prompt to a temp file (same content as current, with `{ROADMAP_CONTEXT}` and `{ARTIFACT_CONTENT}` substituted).
   - Invoke: `RESULTS_JSON=$(node ~/.claude/get-shit-done/bin/gsd-tools.cjs coplanner invoke-all --checkpoint "verification" --prompt-file "$PROMPT_FILE")`
   - Parse results array.
3. **Failure triage**: Same pattern -- all-failed skips to step 7.5, some-failed shows warning.
4. **Per-agent feedback blocks**: Same format.
5. **Merged Synthesis**: Theme-based organization with bracket-tag attribution. Use verification-specific acceptance criteria (accept missed cases/false positives/evidence gaps; reject stylistic/speculative).
6. **Update synthesis table** to include "Source(s)" column.
7. Keep conditional commit with scope `docs({phase}): incorporate co-planner feedback (verification)`.
8. Keep existing Edit tool usage for verification artifact modification (not Write).

**Key structural changes (both files):**
- Remove the "For each agent" sequential loop and per-agent `coplanner invoke` calls
- Replace with single `invoke-all` call + results parsing
- Add failure triage section
- Add "Merged Synthesis" heading with theme organization and bracket attribution
- Add "Source(s)" column to synthesis table
- For conflicts between agents: "AgentA suggested X but AgentB flagged Y -- {resolution}"
  </action>
  <verify>
1. `grep -c "coplanner invoke-all" commands/gsd/plan-phase.md` returns 1
2. `grep -c "coplanner invoke-all" commands/gsd/execute-phase.md` returns 1
3. `grep -c "For each agent" commands/gsd/plan-phase.md` returns 0 (sequential loop removed)
4. `grep -c "For each agent" commands/gsd/execute-phase.md` returns 0 (sequential loop removed)
5. `grep "Merged Synthesis" commands/gsd/plan-phase.md` returns match
6. `grep "Merged Synthesis" commands/gsd/execute-phase.md` returns match
7. `grep "prompt-file" commands/gsd/plan-phase.md` returns match
8. `grep "prompt-file" commands/gsd/execute-phase.md` returns match
9. Verify execute-phase.md still uses Edit tool (not Write) for verification artifact modification
10. Verify execute-phase.md still has skip conditions for gaps_found and re_verification
  </verify>
  <done>Both plan-phase.md (step 12.3) and execute-phase.md (step 7.3) use `coplanner invoke-all` for parallel invocation, display per-agent feedback blocks followed by theme-based merged synthesis with bracket-tag attribution, handle partial/total failures, and preserve checkpoint-specific acceptance criteria and skip conditions.</done>
</task>

</tasks>

<verification>
1. All four co-planner review sections across three files use `coplanner invoke-all`
2. No sequential "for each agent" loops remain in co-planner sections
3. Each section displays per-agent blocks THEN a merged theme-based synthesis
4. Bracket-tag attribution appears in all synthesis sections: `[Agent]` or `[Agent1, Agent2]`
5. Partial failure warning format: `⚠ {N} of {M} agents failed ({agent}: {errorType})`
6. Total failure falls through to adversary review with warning message
7. Checkpoint-specific acceptance criteria preserved (requirements vs plan vs verification)
8. execute-phase.md skip conditions (gaps_found, re_verification) unchanged
9. Conditional commits preserved with correct scope patterns
</verification>

<success_criteria>
- `grep -r "coplanner invoke-all" commands/gsd/` returns 4 matches (one per checkpoint section)
- `grep -r "For each agent" commands/gsd/` returns 0 matches in co-planner sections
- `grep -r "Merged Synthesis" commands/gsd/` returns 4 matches (one per checkpoint section)
- All four sections handle partial failure (inline warning) and total failure (skip to adversary)
- Theme-based synthesis with bracket attribution in all four sections
</success_criteria>

<output>
After completion, create `.planning/phases/09-multi-agent-orchestration/09-02-SUMMARY.md`
</output>
