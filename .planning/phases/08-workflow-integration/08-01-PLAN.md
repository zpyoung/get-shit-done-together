---
phase: 08-workflow-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - commands/gsd/new-project.md
autonomous: true

must_haves:
  truths:
    - "Co-planner review runs before adversary review at the requirements checkpoint in new-project"
    - "Co-planner review runs before adversary review at the roadmap checkpoint in new-project"
    - "Each co-planner agent's feedback is displayed in a bordered, attributed block before synthesis"
    - "An explicit accept/reject log is displayed after synthesizing co-planner feedback"
    - "When no co-planner agents are configured, the section is silently skipped and adversary review runs normally"
    - "When a co-planner agent fails, a warning is displayed and the workflow continues"
  artifacts:
    - path: "commands/gsd/new-project.md"
      provides: "Co-planner review sections at Phase 7.3 (requirements) and Phase 8.3 (roadmap)"
      contains: "Phase 7.3"
  key_links:
    - from: "commands/gsd/new-project.md Phase 7.3"
      to: "gsd-tools.cjs coplanner agents requirements"
      via: "bash invocation for agent resolution"
      pattern: "coplanner agents.*requirements"
    - from: "commands/gsd/new-project.md Phase 8.3"
      to: "gsd-tools.cjs coplanner agents roadmap"
      via: "bash invocation for agent resolution"
      pattern: "coplanner agents.*roadmap"
---

<objective>
Add co-planner review sections to `commands/gsd/new-project.md` at the requirements and roadmap checkpoints.

Purpose: Enable external agents to provide refinement feedback on REQUIREMENTS.md and ROADMAP.md before adversary challenge, implementing the draft-review-synthesize pattern at the first two checkpoint types.

Output: Two new sections (Phase 7.3 and Phase 8.3) in new-project.md, each following the co-planner review pattern: resolve agents, skip if none, banner, per-agent invoke/display, synthesis with accept/reject log, conditional commit.
</objective>

<execution_context>
@/Users/zpyoung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zpyoung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-workflow-integration/08-RESEARCH.md
@.planning/phases/08-workflow-integration/08-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add co-planner review at requirements checkpoint (Phase 7.3)</name>
  <files>commands/gsd/new-project.md</files>
  <action>
Insert a new section `## Phase 7.3: Co-Planner Review -- Requirements` immediately BEFORE the existing `## Phase 7.5: Adversary Review -- Requirements` (line 870).

The section must follow this exact structure (consistent with adversary pattern but single-pass, not debate loop):

1. **Agent resolution** (~5 lines): Run `node ~/.claude/get-shit-done/bin/gsd-tools.cjs coplanner agents "requirements"` and parse JSON result to get `agents` array and `warnings` array. Display any warnings.

2. **Skip logic** (~3 lines): If agents array is empty, skip to Phase 7.5 (adversary review). No banner, no output.

3. **Banner** (~8 lines): Display GSD co-planner review banner with checkpoint type and agent count, using the `━━━` border style consistent with other GSD banners.

4. **Per-agent loop** (~30 lines): For each agent in the agents array:
   a. Read REQUIREMENTS.md from disk into ARTIFACT_CONTENT variable
   b. Read first 50 lines of PROJECT.md for project context
   c. Construct review prompt with requirements-specific focus areas: FEASIBILITY (technical blockers?), GAPS (missing requirements?), CONFLICTS (contradictions?), SCOPE (implementation details disguised as requirements?)
   d. Ask agent to organize response into three sections: **Suggestions**, **Challenges**, **Endorsements**
   e. Invoke via `node ~/.claude/get-shit-done/bin/gsd-tools.cjs coplanner invoke {agent} --prompt "$REVIEW_PROMPT"`
   f. Parse result JSON -- check for errorType

5. **Error handling per agent** (~5 lines): If errorType is non-null, display warning `{agent} failed ({errorType}): {error}` and continue to next agent. If ALL agents fail, display warning and skip to Phase 7.5.

6. **Feedback display** (~15 lines): For each successful agent response, display a bordered attributed block:
   ```
   --- {Agent Name} Feedback ---
   (Claude parses response text into Suggestions, Challenges, Endorsements)
   ---
   ```
   Use `---` bordered sections with agent name header (e.g., `--- Codex Feedback ---`).

7. **Synthesis** (~15 lines): Review all suggestions and challenges. For each piece of actionable feedback, decide to accept or reject. Apply accepted changes to REQUIREMENTS.md via Edit tool. Track what was changed.

8. **Accept/reject log** (~10 lines): Display a table showing each feedback item, its source agent, the decision (Accepted/Rejected/Noted), and brief reasoning.

9. **Conditional commit** (~5 lines): If REQUIREMENTS.md was modified, commit with message `docs: incorporate co-planner feedback (requirements)`.

Also update the "skip to" reference at step 7 if any reference points directly to Phase 7.5 -- the flow should now naturally fall through Phase 7.3 first. Per research recommendation: the co-planner section handles its own skip logic, so existing "skip to adversary" references do NOT need changing (the flow falls through naturally).

Total: ~95 lines of markdown instructions.
  </action>
  <verify>
Grep for "Phase 7.3" in commands/gsd/new-project.md -- must find the new section header. Verify "Phase 7.3" appears BEFORE "Phase 7.5" in the file. Verify the section contains: `coplanner agents "requirements"`, `coplanner invoke`, `Co-Planner Synthesis`, and the conditional commit pattern.
  </verify>
  <done>
Phase 7.3 co-planner review section exists in new-project.md immediately before Phase 7.5, with agent resolution, skip logic, banner, per-agent invocation loop, error handling, attributed feedback display, synthesis with accept/reject log, and conditional commit.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add co-planner review at roadmap checkpoint (Phase 8.3)</name>
  <files>commands/gsd/new-project.md</files>
  <action>
Insert a new section `## Phase 8.3: Co-Planner Review -- Roadmap` immediately BEFORE the existing `## Phase 8.5: Adversary Review -- Roadmap` (line 1143).

Follow the SAME structure as Phase 7.3 (Task 1) with these checkpoint-specific differences:

1. Agent resolution uses checkpoint `"roadmap"` instead of `"requirements"`
2. The artifact read from disk is ROADMAP.md instead of REQUIREMENTS.md
3. The review prompt focuses on roadmap-specific concerns: ORDERING (phase sequence, dependencies), RISK DISTRIBUTION (risky items front-loaded?), SCOPE (phases too large/small?), COVERAGE (all requirements mapped to phases?)
4. The conditional commit message is `docs: incorporate co-planner feedback (roadmap)`
5. All skip references point to Phase 8.5 instead of Phase 7.5

Everything else (banner style, per-agent loop, error handling, feedback display, synthesis pattern, accept/reject log) is identical to Phase 7.3.

Total: ~95 lines of markdown instructions.
  </action>
  <verify>
Grep for "Phase 8.3" in commands/gsd/new-project.md -- must find the new section header. Verify "Phase 8.3" appears BEFORE "Phase 8.5" in the file. Verify the section contains: `coplanner agents "roadmap"`, `coplanner invoke`, `Co-Planner Synthesis`, and the conditional commit pattern.
  </verify>
  <done>
Phase 8.3 co-planner review section exists in new-project.md immediately before Phase 8.5, with roadmap-tailored review prompt and all standard co-planner review components.
  </done>
</task>

</tasks>

<verification>
1. `grep -n "Phase 7.3" commands/gsd/new-project.md` returns line number(s)
2. `grep -n "Phase 8.3" commands/gsd/new-project.md` returns line number(s)
3. Phase 7.3 line number < Phase 7.5 line number (870 + offset)
4. Phase 8.3 line number < Phase 8.5 line number (1143 + offset from Task 1)
5. Both sections contain: `coplanner agents`, `coplanner invoke`, `Co-Planner Synthesis`, conditional commit
6. No references to Phase 7.5 or 8.5 are broken -- natural fallthrough works
</verification>

<success_criteria>
- new-project.md has 4 review sections in order: 7.3 (co-planner req), 7.5 (adversary req), 8.3 (co-planner roadmap), 8.5 (adversary roadmap)
- Each co-planner section uses the correct checkpoint name for agent resolution
- Each co-planner section has a checkpoint-tailored review prompt
- Feedback display uses bordered attributed blocks per agent
- Accept/reject log template is present
- Conditional commit with correct scope is present
</success_criteria>

<output>
After completion, create `.planning/phases/08-workflow-integration/08-01-SUMMARY.md`
</output>
