---
phase: 05-verification-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - commands/gsd/execute-phase.md
autonomous: true

must_haves:
  truths:
    - "Adversary reviews VERIFICATION.md conclusions after gsd-verifier creates it (when enabled)"
    - "BLOCKING challenges cause gsd-verifier re-spawn to re-examine specific conclusions (verifier-as-defender)"
    - "Verification status is re-read after adversary review and routing uses the updated status"
    - "Adversary is skipped when disabled, during gap-closure re-verification, or when status is already gaps_found"
    - "CONV-01 hard cap of 3 rounds enforced on the verification debate loop"
  artifacts:
    - path: "commands/gsd/execute-phase.md"
      provides: "Step 7.5 adversary verification review with debate loop, verifier-as-defender, and status re-read"
      contains: "ADVERSARY REVIEW"
  key_links:
    - from: "step 7 (verify_phase_goal)"
      to: "step 7.5 (adversary review)"
      via: "sequential flow after VERIFICATION.md creation, before status routing"
      pattern: "7\\.5.*Adversary"
    - from: "step 7.5 adversary BLOCKING challenges"
      to: "gsd-verifier re-spawn in adversary_revision mode"
      via: "Task call with revision_context prompt"
      pattern: "adversary_revision"
    - from: "step 7.5 debate loop exit"
      to: "status re-read and routing"
      via: "grep status from VERIFICATION.md, then route by updated status"
      pattern: "VERIFICATION_STATUS"
---

<objective>
Integrate adversary review into execute-phase verification step (step 7.5), challenging VERIFICATION.md conclusions with the established debate loop pattern.

Purpose: Final adversary checkpoint -- catches false positives, blind spots, and coverage gaps in the verifier's analysis before the phase is marked complete.
Output: Updated execute-phase.md with adversary verification review between step 7 and step 8.
</objective>

<execution_context>
@/Users/zpyoung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zpyoung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-verification-integration/05-RESEARCH.md
@.planning/phases/03-new-project-integration/03-01-SUMMARY.md
@.planning/phases/04-plan-integration/04-01-SUMMARY.md
@commands/gsd/execute-phase.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add adversary infrastructure and restructure step 7 routing</name>
  <files>commands/gsd/execute-phase.md</files>
  <action>
    Three changes to execute-phase.md:

    **1a. Add gsd-adversary to the model lookup table in step 0:**

    Add a new row to the existing model table:
    ```
    | gsd-adversary | sonnet | sonnet | haiku |
    ```

    This matches the model profile entry established in Phase 3 (new-project.md) and Phase 4 (plan-phase.md).

    **1b. Add planning-config.md to execution_context:**

    Add this line to the `<execution_context>` section:
    ```
    @~/.claude/get-shit-done/references/planning-config.md
    ```

    This provides the adversary config reading reference, same as Phase 3 and Phase 4 integrations.

    **1c. Restructure step 7 to separate verification from routing:**

    Currently step 7 does both verification AND routing (status-based routing to step 8, human_needed, or gaps_found). The adversary review (step 7.5) must run BETWEEN verification and routing because the adversary may cause re-examination that changes the status.

    Modify step 7 to:
    - Keep: spawning gsd-verifier, creating VERIFICATION.md
    - Remove: the status-based routing bullets (`passed` -> step 8, `human_needed` -> present items, `gaps_found` -> offer plan-phase --gaps)
    - Add: "Continue to step 7.5" after VERIFICATION.md creation
    - The routing logic moves to step 7.5 (after the adversary has had a chance to influence the status)

    The step 7 text should end with: "Continue to step 7.5 (adversary review). Status routing happens after adversary review."

    Keep the verifier skip logic intact: if `workflow.verifier` is `false`, skip to step 8 (treat as passed). This skips BOTH verification AND adversary review, since there's no VERIFICATION.md to challenge.
  </action>
  <verify>
    Read commands/gsd/execute-phase.md and confirm:
    1. gsd-adversary row exists in model lookup table with sonnet/sonnet/haiku
    2. planning-config.md appears in execution_context
    3. Step 7 spawns verifier and creates VERIFICATION.md but does NOT route by status
    4. Step 7 ends with direction to continue to step 7.5
    5. Verifier skip logic (workflow.verifier=false) still skips to step 8
  </verify>
  <done>
    Model table has gsd-adversary entry, execution_context includes planning-config.md, and step 7 creates VERIFICATION.md without premature routing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Insert step 7.5 adversary review with debate loop and update completion display</name>
  <files>commands/gsd/execute-phase.md</files>
  <action>
    Three changes to execute-phase.md:

    **2a. Insert step 7.5: Adversary Review -- Verification**

    Add between step 7 and step 8 (which is "Update roadmap and state"). This is the core integration. Follow the Phase 3 debate loop pattern with these verification-specific adaptations:

    ```markdown
    7.5. **Adversary Review -- Verification**

    Read adversary config for the "verification" checkpoint:

    ```bash
    CHECKPOINT_NAME="verification"
    CHECKPOINT_CONFIG=$(node -e "
      try {
        const c = JSON.parse(require('fs').readFileSync('.planning/config.json', 'utf8'));
        const adv = c.adversary || {};
        if (adv.enabled === false) { console.log('false|3'); process.exit(0); }
        const cp = adv.checkpoints?.[process.argv[1]];
        let enabled, rounds;
        if (typeof cp === 'boolean') { enabled = cp; rounds = adv.max_rounds ?? 3; }
        else if (typeof cp === 'object' && cp !== null) { enabled = cp.enabled ?? true; rounds = cp.max_rounds ?? adv.max_rounds ?? 3; }
        else { enabled = true; rounds = adv.max_rounds ?? 3; }
        console.log(enabled + '|' + rounds);
      } catch(e) { console.log('true|3'); }
    " "$CHECKPOINT_NAME" 2>/dev/null || echo "true|3")

    CHECKPOINT_ENABLED=$(echo "$CHECKPOINT_CONFIG" | cut -d'|' -f1)
    MAX_ROUNDS=$(echo "$CHECKPOINT_CONFIG" | cut -d'|' -f2)

    # Apply CONV-01 hard cap
    EFFECTIVE_MAX_ROUNDS=$((MAX_ROUNDS > 3 ? 3 : MAX_ROUNDS))
    ```

    **Skip conditions** (skip to status routing below):
    - `CHECKPOINT_ENABLED = "false"` -- adversary disabled for verification
    - VERIFICATION.md has `re_verification:` metadata (gap-closure re-check, not initial verification)
    - Verification status is already `gaps_found` -- verifier already found problems, adversary redundant

    **If checkpoint enabled AND initial verification AND status is `passed` or `human_needed`:**

    Display stage banner: `GSD > ADVERSARY REVIEW` with subtitle `Reviewing verification conclusions...`

    **Debate loop** (initialize ROUND=1, CONVERGED=false):

    While ROUND <= EFFECTIVE_MAX_ROUNDS AND NOT CONVERGED:

    1. Read VERIFICATION.md content from disk:
       ```bash
       ARTIFACT_CONTENT=$(cat "$PHASE_DIR"/*-VERIFICATION.md)
       PROJECT_CONTEXT=$(head -50 .planning/PROJECT.md)
       ```

    2. Spawn gsd-adversary:
       - Round 1: Include `<artifact_type>verification</artifact_type>`, `<artifact_content>`, `<round>1</round>`, `<max_rounds>`, `<project_context>`
       - Round > 1: Also include `<defense>` (from verifier re-analysis) and `<previous_challenges>`

       ```
       Task(prompt=adversary_prompt, subagent_type="gsd-adversary", model="{adversary_model}")
       ```

    3. Parse adversary response: challenges[] with severities, convergence recommendation

    4. If convergence == CONVERGE AND ROUND > 1: set CONVERGED=true, break

    5. If ROUND < EFFECTIVE_MAX_ROUNDS AND BLOCKING challenges exist:
       - Re-spawn gsd-verifier in adversary_revision mode (verifier-as-defender):
         ```
         Task(prompt=revision_prompt, subagent_type="gsd-verifier", model="{verifier_model}")
         ```
       - Revision prompt includes: current VERIFICATION.md, adversary challenges, instructions to re-examine ONLY challenged conclusions (not full re-verification)
       - Build DEFENSE text from verifier's return (which conclusions revised, which maintained with evidence)

    6. If MAJOR/MINOR only (no BLOCKING): note challenges, no verifier re-spawn needed

    7. Store previous challenges, increment ROUND

    **After loop:** Display adversary review summary (addressed/noted/unresolved markers per Phase 3 pattern).

    **Status routing (moved from step 7):**

    Re-read verification status from disk (may have changed during adversary review):
    ```bash
    VERIFICATION_STATUS=$(grep "^status:" "$PHASE_DIR"/*-VERIFICATION.md | cut -d: -f2 | tr -d ' ')
    ```

    Route by VERIFICATION_STATUS:
    - `passed` -> continue to step 8
    - `human_needed` -> present items needing human verification, get approval or feedback
    - `gaps_found` -> present gaps, offer `/gsd:plan-phase {X} --gaps`

    **2b. Update step 11 offer_next completion display:**

    In the Route A and Route B completion banners, add a conditional line after "Goal verified":
    ```
    Adversary reviewed: verification    (only show if adversary ran)
    ```

    Same pattern as Phase 3's completion banner update.

    **2c. Update success_criteria:**

    Add to the existing success_criteria list:
    ```
    - [ ] Adversary reviewed verification conclusions (if enabled)
    - [ ] Verification status re-read after adversary review for accurate routing
    ```
  </action>
  <verify>
    Read commands/gsd/execute-phase.md and trace all routing paths:
    1. Step 7 with verifier=false -> skips to step 8 (no adversary, no verification)
    2. Step 7 with verifier=true -> creates VERIFICATION.md -> step 7.5
    3. Step 7.5 with adversary disabled -> skip to status routing within 7.5
    4. Step 7.5 with re_verification -> skip to status routing within 7.5
    5. Step 7.5 with gaps_found status -> skip to status routing within 7.5
    6. Step 7.5 with adversary enabled + passed/human_needed -> debate loop -> status routing
    7. Status routing: passed -> step 8, human_needed -> present checklist, gaps_found -> offer gap closure
    8. Confirm CONV-01 hard cap applied
    9. Confirm adversary summary display present
    10. Confirm status re-read after debate loop
  </verify>
  <done>
    Step 7.5 exists with full verification adversary debate loop, verifier-as-defender for BLOCKING challenges, status re-read after loop, and all routing paths correctly flow through the adversary review.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the complete flow:

1. **Model table:** gsd-adversary row with sonnet/sonnet/haiku
2. **Execution context:** planning-config.md referenced
3. **Step 7:** Creates VERIFICATION.md, does NOT route by status, continues to 7.5
4. **Step 7.5:** Config reading, skip conditions, debate loop, verifier-as-defender, status re-read, then routing
5. **Step 8-11:** Unchanged except offer_next and success_criteria updates
6. **All routing paths verified:** 7 paths from verifier-disabled through each status outcome
7. **CONV-01 hard cap:** Math.min(configuredMaxRounds, 3) applied
8. **No adversary on gap-closure:** re_verification metadata check skips adversary
</verification>

<success_criteria>
- [ ] gsd-adversary in model lookup table (sonnet/sonnet/haiku)
- [ ] planning-config.md in execution_context
- [ ] Step 7 creates VERIFICATION.md without status routing
- [ ] Step 7.5 reads adversary config for "verification" checkpoint
- [ ] Step 7.5 skips when disabled, re-verification, or gaps_found
- [ ] Step 7.5 runs debate loop with verifier-as-defender for BLOCKING
- [ ] Step 7.5 re-reads VERIFICATION_STATUS after debate loop
- [ ] Status routing in step 7.5 handles passed/human_needed/gaps_found
- [ ] CONV-01 hard cap enforced (max 3 rounds)
- [ ] Completion banner shows adversary review (conditional)
- [ ] success_criteria updated with adversary items
</success_criteria>

<output>
After completion, create `.planning/phases/05-verification-integration/05-01-SUMMARY.md`
</output>
