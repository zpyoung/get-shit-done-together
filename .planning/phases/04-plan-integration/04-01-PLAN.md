---
phase: 04-plan-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - commands/gsd/plan-phase.md
autonomous: true

must_haves:
  truths:
    - "When adversary is enabled in config, /gsd:plan-phase displays 'GSD > ADVERSARY REVIEW' banner and per-plan challenge summary after plan checker completes (or is skipped)"
    - "Each PLAN.md gets its own adversary review loop with prior plans passed as cross-plan context"
    - "BLOCKING challenges trigger planner re-spawn in adversary_revision mode and the plan is updated on disk"
    - "Debate loop terminates after at most 3 rounds regardless of user-configured max_rounds (CONV-01 hard cap)"
    - "Adversary review runs independently of checker config -- skipping checker (--skip-verify or plan_check=false) does not skip adversary"
    - "Adversary does NOT run in gap closure mode (--gaps)"
    - "When adversary is disabled in config (globally or per-checkpoint), the flow proceeds without adversary review"
    - "PLAN.md files contain no trace of the adversary review process (clean artifacts)"
  artifacts:
    - path: "commands/gsd/plan-phase.md"
      provides: "Per-plan adversary debate loop with planner-as-defender pattern"
      contains: "ADVERSARY REVIEW"
  key_links:
    - from: "commands/gsd/plan-phase.md"
      to: "get-shit-done/references/planning-config.md"
      via: "execution_context @-reference"
      pattern: "planning-config\\.md"
    - from: "commands/gsd/plan-phase.md"
      to: "agents/gsd-adversary.md"
      via: "Task tool spawn with gsd-adversary agent"
      pattern: "gsd-adversary"
    - from: "commands/gsd/plan-phase.md"
      to: "agents/gsd-planner.md"
      via: "Task tool re-spawn in adversary_revision mode"
      pattern: "adversary_revision"
    - from: "commands/gsd/plan-phase.md Step 12.5"
      to: "Step 12 (checker revision loop)"
      via: "Inserted after checker loop completes, before final status"
      pattern: "ADVERSARY REVIEW"
    - from: "commands/gsd/plan-phase.md Step 9"
      to: "Step 12.5"
      via: "Skip-verify/plan_check=false routes to adversary instead of step 13"
      pattern: "step 12\\.5"
---

<objective>
Integrate per-plan adversary review loop into /gsd:plan-phase with planner-as-defender revision pattern.

Purpose: This wires the adversary agent into the plan-phase workflow so each PLAN.md is stress-tested after creation. Unlike Phase 3 (where the orchestrator defended inline), Phase 4 uses planner-as-defender -- the planner agent is re-spawned to revise plans based on adversary challenges. This produces higher-quality plan revisions because the planner has plan-level domain knowledge. The debate loop pattern from Phase 3 is reused for config reading, convergence, and summary display.

Output: Modified `commands/gsd/plan-phase.md` with adversary review at Step 12.5, updated flow control, and completion banner.
</objective>

<execution_context>
@/Users/zpyoung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zpyoung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-plan-integration/04-RESEARCH.md
@.planning/phases/04-plan-integration/04-CONTEXT.md
@.planning/phases/03-new-project-integration/03-01-SUMMARY.md

Key references inside the file being modified:
@commands/gsd/plan-phase.md
@agents/gsd-adversary.md
@agents/gsd-planner.md
@get-shit-done/references/planning-config.md
@get-shit-done/references/ui-brand.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add adversary infrastructure and per-plan review loop</name>
  <files>commands/gsd/plan-phase.md</files>
  <action>
Make three changes to `commands/gsd/plan-phase.md`:

**1. Add planning-config.md to execution_context section (line ~17-19):**

Add `@~/.claude/get-shit-done/references/planning-config.md` to the `<execution_context>` block. This provides the adversary config reading block as a reference (same as Phase 3 did for new-project.md).

**2. Add gsd-adversary to model lookup table in Step 1 (line ~62-68):**

Add a new row to the model lookup table:

```
| gsd-adversary | sonnet | sonnet | haiku |
```

The planner-revision spawns reuse the existing `gsd-planner` model entry since they re-spawn the same agent. No separate row needed for revision spawns.

**3. Insert Step 12.5: Adversary Review -- Plans:**

Insert a new section between the revision loop (end of Step 12) and the final status presentation (Step 13). The new section is Step 12.5 and contains the full per-plan adversary debate loop with planner-as-defender.

The Step 12.5 section must contain:

a. **Config reading block** -- Read adversary config for the "plan" checkpoint using the `node -e` pattern from planning-config.md (verbatim copy of the established pattern with `CHECKPOINT_NAME="plan"`). Apply CONV-01 hard cap: `EFFECTIVE_MAX_ROUNDS = min(MAX_ROUNDS, 3)`.

b. **Skip logic** -- If `CHECKPOINT_ENABLED = "false"` OR in `--gaps` mode: Skip to step 13. Adversary review adds friction without proportional value for gap closure plans.

c. **Plan enumeration** -- List all PLAN.md files in the phase directory:
   ```bash
   PLAN_FILES=$(ls "${PHASE_DIR}"/*-PLAN.md 2>/dev/null | sort)
   PLAN_COUNT=$(echo "$PLAN_FILES" | wc -l | tr -d ' ')
   ```
   Initialize tracking variables: `PLANS_REVISED=false`, `TOTAL_CHALLENGES=0`, `TOTAL_ADDRESSED=0`, `TOTAL_NOTED=0`

d. **Per-plan debate loop** -- For each PLAN_FILE in PLAN_FILES (in plan number order):

   i. Display banner:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    GSD > ADVERSARY REVIEW
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

   Plan {NN} of {PLAN_COUNT}: Reviewing...
   ```

   ii. Initialize per-plan state: `ROUND=1`, `CONVERGED=false`, `PLAN_REVISED=false`

   iii. Debate loop -- While ROUND <= EFFECTIVE_MAX_ROUNDS AND not CONVERGED:

   1. **Read artifact from disk** (re-read each round to get latest after planner revision):
      ```bash
      ARTIFACT_CONTENT=$(cat "$PLAN_FILE")
      PROJECT_CONTEXT=$(head -50 .planning/PROJECT.md)

      # Gather prior plans (all plans before current in sort order)
      PRIOR_PLANS=""
      for prior in $PLAN_FILES; do
        [ "$prior" = "$PLAN_FILE" ] && break
        PRIOR_PLANS+="$(cat "$prior")\n\n---\n\n"
      done
      ```

   2. **Spawn adversary:**

      **Round 1:**
      ```
      Task(prompt="First, read ~/.claude/agents/gsd-adversary.md for your role and instructions.

      <artifact_type>plan</artifact_type>

      <artifact_content>
      {ARTIFACT_CONTENT}
      </artifact_content>

      <round>1</round>
      <max_rounds>{EFFECTIVE_MAX_ROUNDS}</max_rounds>

      <project_context>
      {PROJECT_CONTEXT}
      </project_context>

      <prior_plans>
      {PRIOR_PLANS — content of prior PLAN.md files in this phase. Empty for plan 01.}
      </prior_plans>
      ", subagent_type="gsd-adversary", model="{adversary_model}", description="Adversary review: plan {NN} (round 1)")
      ```

      **Round > 1:** Same as round 1 plus `<defense>` and `<previous_challenges>` tags:
      ```
      Task(prompt="First, read ~/.claude/agents/gsd-adversary.md for your role and instructions.

      <artifact_type>plan</artifact_type>

      <artifact_content>
      {ARTIFACT_CONTENT — re-read from disk after planner revision}
      </artifact_content>

      <round>{ROUND}</round>
      <max_rounds>{EFFECTIVE_MAX_ROUNDS}</max_rounds>

      <defense>
      {DEFENSE — built from planner's revision return}
      </defense>

      <previous_challenges>
      {PREV_CHALLENGES — adversary's challenges from previous round}
      </previous_challenges>

      <project_context>
      {PROJECT_CONTEXT}
      </project_context>

      <prior_plans>
      {PRIOR_PLANS}
      </prior_plans>
      ", subagent_type="gsd-adversary", model="{adversary_model}", description="Adversary review: plan {NN} (round {ROUND})")
      ```

   3. **Parse adversary response:** Extract challenges (title, severity, concern, evidence, affected) and convergence recommendation (CONTINUE/CONVERGE).

   4. **Check convergence:** If adversary recommends CONVERGE and ROUND > 1: set `CONVERGED=true`, break.

   5. **Handle challenges** (if ROUND < EFFECTIVE_MAX_ROUNDS and BLOCKING challenges exist):

      **Planner-as-defender pattern (KEY DIFFERENCE FROM PHASE 3):**

      Re-spawn the planner agent in adversary_revision mode to address challenges. Do NOT edit the plan inline as the orchestrator -- the planner has plan-level knowledge for higher-quality revisions.

      ```
      Task(prompt="First, read ~/.claude/agents/gsd-planner.md for your role and instructions.

      <revision_context>

      **Phase:** {phase_number}
      **Mode:** adversary_revision
      **Target plan:** {plan_number}

      **Current plan content:**
      {current plan content from disk}

      **Adversary challenges:**
      {adversary's full challenge output — not a summary}

      **Challenge handling instructions:**
      - BLOCKING challenges: Must address with specific plan changes
      - MAJOR challenges: Address if valid, note with rationale if not
      - MINOR challenges: Note without revision (typically)

      </revision_context>

      <instructions>
      Make targeted updates to plan {plan_number} to address adversary challenges.
      Do NOT rewrite the plan from scratch.
      Do NOT modify other plans.
      Write the revised plan to disk at the exact file path: {PLAN_FILE}
      Return what changed and why — this becomes the defense for the next adversary round.
      </instructions>
      ", subagent_type="general-purpose", model="{planner_model}", description="Revise plan {NN} (adversary feedback)")
      ```

      After planner returns:
      - Build `DEFENSE` text from planner's return (what changed + what was rejected with rationale)
      - Store `PREV_CHALLENGES` = adversary's full challenge output from this round
      - Set `PLAN_REVISED=true`, `PLANS_REVISED=true`
      - Update challenge counts: `TOTAL_ADDRESSED += addressed count`

      **For MAJOR/MINOR only (no BLOCKING):** At Claude's discretion, may note without spawning planner. Build defense text noting the rationale for not revising. Store `PREV_CHALLENGES`. Increment `TOTAL_NOTED`.

   6. Increment ROUND

   iv. **Display per-plan summary:**
   ```
   Plan {NN}: Adversary review complete

   **Challenges:**
   - checkmark **[SEVERITY]** {title} -- Addressed: {what changed}
   - circle **[SEVERITY]** {title} -- Noted: {rationale}
   - warning **[SEVERITY]** {title} -- Unresolved: {why}
   ```

   Use checkmark for addressed, circle for noted/minor, warning for unresolved at max rounds.

e. **Consolidated commit** -- After all plans reviewed, if PLANS_REVISED = true:
   ```bash
   git add "${PHASE_DIR}"/*-PLAN.md
   git commit -m "$(cat <<'EOF'
   docs({phase}): incorporate adversary review feedback (plans)
   EOF
   )"
   ```
   Only commit if actual revisions were made. Do not commit if all challenges were noted without revision. This preserves the pre-adversary state in git history (separate from the planner's original commit in step 8 and the checker revision commit in step 12).

f. **Consolidated summary** -- Display after all plans reviewed, before step 13:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    GSD > ADVERSARY REVIEW COMPLETE
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

   {PLAN_COUNT} plan(s) reviewed | {TOTAL_ADDRESSED} challenges addressed | {TOTAL_NOTED} noted
   ```

**Important constraints:**
- Plans are already committed by the planner (step 8) and potentially revised/committed by the checker loop (step 12). Adversary revisions happen AFTER those commits.
- Always re-read PLAN.md from disk before each adversary spawn (round > 1) to get the planner-revised version.
- The planner revision prompt must explicitly state the target plan file path so the planner writes to the correct file.
- Prior plans are full content for all cases (phases in this project have 1-3 plans each; don't pre-optimize).
- PLAN.md files must be clean -- no adversary metadata embedded in the plan content.
- Scope planner revision to the current plan only. Cross-plan issues are noted in the summary but not acted on within the loop.
  </action>
  <verify>
Read commands/gsd/plan-phase.md and verify:
1. `planning-config.md` appears in execution_context
2. `gsd-adversary` row exists in model lookup table with correct model assignments (sonnet/sonnet/haiku)
3. Step 12.5 section exists between Step 12 and Step 13
4. Config reading block uses `node -e` pattern with `CHECKPOINT_NAME="plan"`
5. CONV-01 hard cap applied: `$((MAX_ROUNDS > 3 ? 3 : MAX_ROUNDS))`
6. Skip logic present for disabled checkpoint AND --gaps mode
7. Per-plan loop iterates over each PLAN.md file in sort order
8. Round 1 adversary spawn includes: artifact_type, artifact_content, round, max_rounds, project_context, prior_plans
9. Round > 1 adversary spawn additionally includes: defense, previous_challenges
10. Planner re-spawn uses adversary_revision mode with full challenge output and target plan path
11. Consolidated commit after all plans (conditional on PLANS_REVISED)
12. Per-plan and consolidated summary displays present
  </verify>
  <done>
Step 12.5 adversary review section is complete in plan-phase.md with config reading, per-plan debate loop, planner-as-defender revision pattern, summary display, and consolidated revision commit. Model table and execution_context updated. The plan checkpoint runs after checker verification and before final status presentation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire adversary into flow control and update completion display</name>
  <files>commands/gsd/plan-phase.md</files>
  <action>
Make three changes to `commands/gsd/plan-phase.md`:

**1. Update Step 9 flow control for adversary independence:**

Currently, Step 9 routes to either Step 10 (checker) or Step 13 (skip) based on `--skip-verify` flag and `plan_check` config. Since the adversary runs independently of checker config, Step 9 needs to route correctly when checker is skipped but adversary is enabled.

Modify the routing logic in Step 9:

- **`## PLANNING COMPLETE` handler:**
  - If `--skip-verify`: Skip to **step 12.5** (adversary review, which has its own skip logic) instead of step 13
  - If `workflow.plan_check` is `false`: Skip to **step 12.5** instead of step 13
  - Otherwise: Proceed to step 10 (checker) as before

This ensures the adversary always gets a chance to run regardless of checker config. Step 12.5's own skip logic (checking adversary config + --gaps mode) handles the case where adversary is also disabled.

The specific text changes:
- Where it says `If --skip-verify: Skip to step 13` change to `If --skip-verify: Skip to step 12.5`
- Where it says `If workflow.plan_check is false: Skip to step 13` change to `If workflow.plan_check is false: Skip to step 12.5`

**2. Update Step 13 offer_next with adversary mention:**

In the `<offer_next>` section, add an "Adversary" line after the "Verification" line:

```
Research: {Completed | Used existing | Skipped}
Verification: {Passed | Passed with override | Skipped}
Adversary: {Reviewed N plan(s) | Skipped (disabled) | Skipped (gap closure)}
```

The adversary status line appears only if the adversary review step was reached. Track this with a variable set in Step 12.5 (e.g., `ADVERSARY_RAN=true` / `ADVERSARY_SKIPPED_DISABLED=true` / `ADVERSARY_SKIPPED_GAPS=true`).

**3. Update success_criteria section:**

Add adversary-related verification items to the `<success_criteria>` list:

```
- [ ] Adversary review completed (unless disabled or --gaps)
- [ ] Adversary runs independently of --skip-verify and plan_check config
- [ ] Per-plan adversary challenges displayed with severity markers
```

These go after the existing checker-related criteria and before the user-facing criteria.

**Important constraints:**
- Step 9 routing changes are minimal -- only changing the target step number (13 to 12.5) in two places
- The offer_next change adds one line to an existing display block
- The success_criteria change adds three items to an existing checklist
- Do NOT change the fundamental flow of steps 10-12 (checker loop) -- those remain unchanged
  </action>
  <verify>
Read commands/gsd/plan-phase.md and verify:
1. Step 9 routes to step 12.5 (not step 13) when --skip-verify or plan_check=false
2. Step 9 still routes to step 10 when checker is enabled (unchanged)
3. offer_next section includes "Adversary:" status line after "Verification:" line
4. success_criteria includes adversary verification items
5. No other steps were accidentally modified
6. The flow reads logically: Step 9 -> (10-12 or skip) -> 12.5 -> 13
  </verify>
  <done>
Step 9 flow control updated to route through adversary review regardless of checker config. Completion banner and success criteria reflect adversary review status. The full plan-phase flow now correctly handles all combinations: checker+adversary, checker-only, adversary-only, neither, and gap closure mode.
  </done>
</task>

</tasks>

<verification>
After both tasks, verify the complete integration:

1. **Structure check:** Read commands/gsd/plan-phase.md end-to-end and confirm:
   - execution_context includes planning-config.md reference
   - Model table has gsd-adversary row
   - Step 9 routes to step 12.5 when checker is skipped
   - Step 12.5 exists between Step 12 and Step 13
   - Step 13 offer_next has adversary mention
   - success_criteria has adversary items
   - No other sections were accidentally modified or removed

2. **Flow correctness:** Trace all routing paths:
   - checker enabled + adversary enabled: 9 -> 10 -> 11 -> 12 -> 12.5 -> 13
   - checker enabled + adversary disabled: 9 -> 10 -> 11 -> 12 -> 12.5 (skip) -> 13
   - checker disabled + adversary enabled: 9 -> 12.5 -> 13
   - checker disabled + adversary disabled: 9 -> 12.5 (skip) -> 13
   - --gaps mode: 9 -> 10 -> 11 -> 12 -> 12.5 (skip, --gaps) -> 13
   - --skip-verify + adversary enabled: 9 -> 12.5 -> 13
   - --skip-verify + adversary disabled: 9 -> 12.5 (skip) -> 13

3. **Pattern consistency with Phase 3:** Both Phase 3 and Phase 4 debate loops:
   - Use identical config reading block (only CHECKPOINT_NAME differs)
   - Apply CONV-01 hard cap identically
   - Use same banner and summary display format
   - Handle severity the same way (BLOCKING=revise, MAJOR=discretion, MINOR=note)
   - Track convergence the same way

4. **Phase 4 unique patterns verified:**
   - Per-plan iteration (loop over each PLAN.md)
   - Planner-as-defender (re-spawn planner, not inline editing)
   - Prior plans as context (cross-plan gap detection)
   - Consolidated commit (one commit for all plan revisions)
   - Adversary independent of checker config

5. **Requirement coverage:**
   - INTG-03: Adversary challenges PLAN.md after creation in /gsd:plan-phase (if enabled)
   - CONV-01: Debate loop hard cap at 3 rounds enforced

6. **Anti-pattern check:**
   - Orchestrator does NOT edit plans inline (planner-as-defender)
   - Plans are NOT batched into one adversary call (per-plan review)
   - Adversary does NOT run before checker (runs after step 12)
   - Adversary does NOT modify plans directly (planner revises)
   - Adversary does NOT re-run after user force-proceed from checker
   - Adversary does NOT run in --gaps mode
</verification>

<success_criteria>
- commands/gsd/plan-phase.md contains adversary review at Step 12.5 with per-plan debate loop
- Planner-as-defender pattern: planner agent re-spawned for revisions, not orchestrator editing inline
- Prior plans passed as context to adversary for cross-plan gap detection
- Config reading uses established node -e pattern from planning-config.md
- CONV-01 hard cap of 3 rounds enforced
- Adversary runs independently of checker config (--skip-verify and plan_check=false route to 12.5)
- Adversary skipped in --gaps mode and when disabled in config
- Model table includes gsd-adversary with correct profile assignments
- Completion banner reflects adversary review status
- Clean artifacts: PLAN.md files contain no adversary metadata
- One consolidated commit for all adversary-driven plan revisions
- Existing plan-phase flow preserved -- adversary is additive, not disruptive
</success_criteria>

<output>
After completion, create `.planning/phases/04-plan-integration/04-01-SUMMARY.md`
</output>
